<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Family Life Dashboard</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <script src="config.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <style>
    :root { --bg: linear-gradient(to bottom right, red, orange, yellow, green, blue, indigo, violet); --text:#333; --section-bg:#fff; }
    body.dark { --bg:#111; --text:#f1f1f1; --section-bg:#222; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; background:var(--bg); color:var(--text); }
    header { background:rgba(255,255,255,.85); padding:1rem; text-align:center; font-size:1.5rem; font-weight:800; border-bottom:3px solid #fff; position:relative; z-index:1; }
    .dark header{ background:rgba(0,0,0,.8); border-bottom:3px solid #444; }
    section { background:var(--section-bg); margin:1rem; padding:1rem; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,.08); }
    h2, h3 { margin:.25rem 0 .5rem; }
    details summary { font-weight:800; cursor:pointer; margin-bottom:.8rem; }
    ul { list-style:none; padding:0; margin:0; }
    li button { margin:4px 0; padding:.55rem 1rem; font:600 1rem system-ui; border:0; border-radius:7px; background:#81c784; color:#fff; cursor:pointer; }
    li button:hover{ background:#66bb6a; }
    .toggle-mode { position:fixed; bottom:1rem; right:1rem; width:50px; height:50px; background:#000; color:#fff; border:0; border-radius:50%; font-size:24px; cursor:pointer; z-index:999; display:flex; align-items:center; justify-content:center; box-shadow:0 2px 5px rgba(0,0,0,.3);} 
    .toggle-mode.sun{ background:#ffd700; color:#333; }
    .qr-output{ margin-top:.5rem; }
    .chore-summary h3 { margin-top:.75rem; color:#555; }
    .dark .chore-summary h3{ color:#f1f1f1; }
    .earnings-badge{ display:inline-block; min-width:3em; text-align:right; font-weight:800; color:white; border-radius:6px; padding:2px 8px; }
    .badge-green{background:#2ecc71;} .badge-yellow{background:#f1c40f;} .badge-orange{background:#e67e22;} .badge-grey{background:#7f8c8d;}
    .progress-bar{ background:#ddd; border-radius:10px; overflow:hidden; margin-top:.5rem; height:20px; }
    .progress-fill{ height:100%; background:linear-gradient(90deg,#2ecc71,#27ae60); width:0%; transition:width .5s ease; }

    /* Modal (simple) */
    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:1000; align-items:center; justify-content:center; }
    .modal .content{ background:var(--section-bg); color:var(--text); padding:20px; border-radius:12px; width:90%; max-width:400px; box-shadow:0 2px 10px rgba(0,0,0,.25); }
    .modal .title{ font:800 1.1rem system-ui; text-align:center; padding:10px 12px; color:#fff; border-radius:10px; margin:-20px -20px 14px -20px; background:linear-gradient(90deg,#4caf50,#81c784); }
    .modal .actions{ margin-top:12px; display:flex; gap:10px; justify-content:flex-end; }
    .btn{ padding:.55rem .9rem; font:700 1rem system-ui; border:0; border-radius:8px; cursor:pointer; }
    .btn.primary{ background:#2563eb; color:#fff; }
    .btn.secondary{ background:#e5e7eb; color:#111; }
  </style>
</head>
<body>
  <header>üè° Family Life Dashboard</header>
  <button class="toggle-mode" id="modeToggle">üåô</button>

  <section>
    <details id="wifiSection">
      <summary>üì∂ Show Wi-Fi QR Code</summary>
      <div class="qr-output"><canvas id="qrcode"></canvas></div>
    </details>
  </section>

  <section id="routinesSection">
    <details>
      <summary>‚úÖ Daily Routines</summary>
      <div id="routineUI">Loading routines‚Ä¶</div>
    </details>
  </section>
  
  <section id="practiceSection">
    <details>
      <summary>üé≤ Practice Games</summary>
      <div id="practiceUI">
        <div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:.5rem">
          <select id="practiceChild">
            <option>Robin</option>
            <option>M√©abh</option>
          </select>
          <select id="practiceMode">
            <option value="phonics">Phonics (CVC)</option>
            <option value="spellings">Spellings</option>
            <option value="numbers">Numbers</option>
          </select>
          <select id="practiceLevel">
            <option value="1">Level 1</option>
            <option value="2">Level 2</option>
            <option value="3">Level 3</option>
          </select>
          <button id="practiceStart" class="btn primary">Start</button>
        </div>
        <div id="practiceArea">Choose options and press Start.</div>
      </div>
    </details>
  </section>

  
  <section>
    <details data-role="chore-logger">
      <summary>üßΩ Log a Chore</summary>
      <div id="choreLinks"></div>
    </details>
  </section>

  <section>
    <details open>
      <summary>üìà Weekly Chore Summary</summary>
      <div class="chore-summary" id="summaryContainer">Loading‚Ä¶</div>
    </details>
  </section>

  <section>
    <details>
      <summary>üìÖ Family Calendar</summary>
      <iframe id="calendarFrame" style="border:0;width:100%;height:400px" frameborder="0" scrolling="no"></iframe>
    </details>
  </section>

  <!-- Confirmation Modal -->
  <div class="modal" id="choreConfirm">
    <div class="content">
      <div class="title">Confirm Chore</div>
      <p id="confirmText"></p>
      <div class="actions">
        <button class="btn secondary" id="cancelBtn">Cancel</button>
        <button class="btn primary" id="submitBtn">Yes, submit</button>
      </div>
    </div>
  </div>

<script>
/* ========== Theme ========== */
const modeBtn = document.getElementById('modeToggle');
function setInitialTheme(){
  const stored = localStorage.getItem('theme');
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  const dark = stored ? stored === 'dark' : prefersDark;
  document.body.classList.toggle('dark', dark);
  modeBtn.textContent = dark ? '‚òÄÔ∏è' : 'üåô';
  modeBtn.classList.toggle('sun', dark);
}
modeBtn.onclick = () => {
  const dark = !document.body.classList.contains('dark');
  document.body.classList.toggle('dark', dark);
  localStorage.setItem('theme', dark ? 'dark' : 'light');
  modeBtn.textContent = dark ? '‚òÄÔ∏è' : 'üåô';
  modeBtn.classList.toggle('sun', dark);
};

/* ========== QR + Calendar ========== */
function initQR(){
  new QRious({
    element: document.getElementById('qrcode'),
    size: 200,
    value: `WIFI:S:${window.config.wifiName};T:WPA;P:${window.config.wifiPassword};;`
  });
  if (!localStorage.getItem('seenQR')){
    document.getElementById('wifiSection').setAttribute('open','');
    localStorage.setItem('seenQR','1');
  }
}
function initCalendar(){
  const src = encodeURIComponent(window.config.calendarEmail);
  document.getElementById('calendarFrame').src =
    `https://calendar.google.com/calendar/embed?height=400&wkst=1&bgcolor=%23ffffff&ctz=Europe/London&showTitle=0&showNav=1&mode=AGENDA&src=${src}`;
}

/* ========== Chores UI ========== */
const CHORES = {
  "Robin": ["Tidy Room","Empty/Refill Dishwasher","Set the Table","Help with the Washing","House Cleaning","Other"],
  "M√©abh": ["Tidy Room","Empty/Refill Dishwasher","Set the Table","Help with the Washing","House Cleaning","Other"]
};
function renderChoreButtons(){
  const wrap = document.getElementById('choreLinks');
  wrap.innerHTML = '';
  Object.keys(CHORES).forEach(name => {
    const group = document.createElement('div');
    group.innerHTML = `<h3>${name}</h3>`;
    const ul = document.createElement('ul');
    CHORES[name].forEach(chore => {
      const li = document.createElement('li');
      const btn = document.createElement('button');
      btn.textContent = chore;
      btn.onclick = () => openConfirm(name, chore);
      li.appendChild(btn); ul.appendChild(li);
    });
    group.appendChild(ul);
    wrap.appendChild(group);
  });
}

/* ========== Confirm + Submit ========== */
let pending = { child: '', chore: '' };
const modal = document.getElementById('choreConfirm');
const cancelBtn = document.getElementById('cancelBtn');
const submitBtn = document.getElementById('submitBtn');

cancelBtn.onclick = () => { modal.style.display='none'; pending={child:'', chore:''}; };
submitBtn.onclick = submitChore;

function openConfirm(name, chore){
  pending.child = name;
  pending.chore = chore;
  document.getElementById('confirmText').textContent = `Did ${name} complete: ‚Äú${chore}‚Äù?`;
  modal.style.display = 'flex';
}

function submitChore(){
  if (!pending.child || !pending.chore) return;

  // Post as x-www-form-urlencoded ‚Üí avoids preflight/CORS
  const body = new URLSearchParams();
  body.set('child', pending.child);
  body.set('chore', pending.chore);
  body.set('ts', Date.now());

  fetch(window.config.choreSubmitUrl, {
    method: 'POST',
    mode: 'no-cors',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: body.toString()
  }).catch(()=>{}); // best-effort; the summary reload will show result

  // Collapse the ‚ÄúLog a Chore‚Äù panel after submitting
  const logger = document.querySelector('details[data-role="chore-logger"]');
  if (logger) logger.removeAttribute('open');

  // Close the modal
  modal.style.display = 'none';

  // Refresh the summary section after a brief delay
  setTimeout(loadSummary, 700);
}

/* ========== Summary fetch (cache-busted + key normaliser) ========== */
function normalizeData(raw){
  // Rebuild a clean object with NFC-normalised keys and numeric coercion
  const out = {};
  for (const [k, v] of Object.entries(raw || {})) {
    const keyN = String(k).normalize('NFC');
    let mapped = keyN;
    if (keyN === 'Meabh') mapped = 'M√©abh';
    if (keyN.toLowerCase() === 'robin') mapped = 'Robin';
    out[mapped] = {
      ...(v || {}),
      count: Number((v && v.count) != null ? v.count : 0),
      weekly: Number((v && v.weekly) != null ? v.weekly : 0),
      total: Number((v && v.total) != null ? v.total : 0),
      goalAmount: Number((v && v.goalAmount) != null ? v.goalAmount : 0),
      goal: (v && v.goal) ? v.goal : ''
    };
  }
  return out;
}

function getSummaryUrl(){
  // Strip any existing query/hash then add a timestamp cache-buster
  const base = (window.config && window.config.summaryUrl) ? String(window.config.summaryUrl) : '';
  const clean = base.split('#')[0].split('?')[0];
  return `${clean}?t=${Date.now()}`;
}

function loadSummary(){
  const el = document.getElementById('summaryContainer');
  el.textContent = 'Loading‚Ä¶';

  const url = getSummaryUrl();
  console.log('[Summary] Fetch:', url);

  fetch(url, { cache: 'no-store' })
    .then(r => { console.log('[Summary] HTTP', r.status); return r.json(); })
    .then(raw => {
      console.log('[Summary] Raw JSON:', raw);
      const data = normalizeData(raw); console.log('[Summary] Normalised M√©abh:', data['M√©abh']);

      // Expected shape: { Robin:{count,weekly,total,goal,goalAmount}, M√©abh:{...} }
      el.innerHTML = '';
      Object.entries(data).forEach(([name, person]) => {
        if (!person) return;
        const id = name === 'Robin' ? 'robin' : 'meabh';
        const weekly = Number(person.weekly||0);
        const total  = Number(person.total||0);
        const goal   = person.goal || '';
        const goalAmt= Number(person.goalAmount||0);

        const card = document.createElement('div');
        card.innerHTML = `
          <h3>${name}</h3>
          <p>Chores completed this week: <strong id="${id}Count">${person.count ?? 0}</strong></p>
          <p>Weekly earnings: ¬£<span id="${id}Earnings" class="earnings-badge">${weekly.toFixed(2)}</span></p>
          <p>üéØ Goal: <span>${goal || "‚Äî"}</span> (¬£<span>${goalAmt ? goalAmt.toFixed(2) : "‚Äî"}</span>)</p>
          <div class="progress-bar"><div id="${id}Goal" class="progress-fill"></div></div>
          <p>Total so far: ¬£<strong id="${id}Total">${total.toFixed(2)}</strong></p>
        `;
        el.appendChild(card);

        // Colour the weekly badge
        const badge = card.querySelector(`#${id}Earnings`);
        badge.classList.remove('badge-green','badge-yellow','badge-orange','badge-grey');
        if (weekly >= 5) badge.classList.add('badge-green');
        else if (weekly === 3) badge.classList.add('badge-yellow');
        else if (weekly === 1) badge.classList.add('badge-orange');
        else badge.classList.add('badge-grey');

        // Progress towards goal
        const fill = card.querySelector(`#${id}Goal`);
        const progress = (goalAmt > 0) ? Math.min((total/goalAmt)*100, 100) : 0;
        fill.style.width = `${progress}%`;

        if (weekly >= 5) confetti();
      });

      // Minimal inline debug to keep while we sort this
      const rob = data['Robin']?.count ?? 0;
      const mea = data['M√©abh']?.count ?? 0;
      console.log(`[Summary] Rendered counts ‚Üí Robin: ${rob}, M√©abh: ${mea}`);
    })
    .catch(err => { 
      console.error('[Summary] Error:', err);
      el.textContent = 'Could not load summary.'; 
    });
}

  <script>
/* ---------- Routines & Practice (modular, namespaced) ---------- */
(function(){
  const API_BASE = (window.config && window.config.summaryUrl) ? String(window.config.summaryUrl).split('?')[0] : '';
  if (!window.HomeLife) window.HomeLife = {};

  function httpGet(url){ return fetch(url, { cache:'no-store' }).then(r=>r.json()); }
  function httpPost(form){
    return fetch(API_BASE, {
      method:'POST', mode:'no-cors',
      headers:{'Content-Type':'application/x-www-form-urlencoded'},
      body:new URLSearchParams(form).toString()
    }).catch(()=>{});
  }
  function dayName(d=new Date()){ return ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][d.getDay()]; }
  function isMorning(){ const h=new Date().getHours(); return h>=5 && h<12; }

  const Routine = {
    state:{ list:[], childOrder:['Robin','M√©abh'] },
    mount(){ this.el=document.getElementById('routineUI'); if(this.el) this.load(); },
    load(){
      const url = `${API_BASE}?routine=list&when=${isMorning()?'morning':'evening'}&day=${dayName()}`;
      httpGet(url).then(d=>{ this.state.list=d||[]; this.render(); })
                  .catch(()=>{ if(this.el) this.el.textContent='Could not load routines.'; });
    },
    render(){
      if(!this.el) return;
      const by={};
      (this.state.list||[]).forEach(r=>{ (by[r.child] ||= []).push(r); });
      const wrap=document.createElement('div');
      this.state.childOrder.forEach(ch=>{
        const items=(by[ch]||[]).sort((a,b)=>(a.order||0)-(b.order||0));
        const box=document.createElement('div');
        box.style.marginBottom='10px';
        box.innerHTML = `<h3>${ch} ‚Äì ${isMorning()?'Morning':'Evening'}</h3>`;
        if(!items.length){ box.innerHTML += '<p>No routines configured.</p>'; wrap.appendChild(box); return; }
        const ul=document.createElement('ul'); ul.style.listStyle='none'; ul.style.padding=0;
        items.forEach(it=>{
          const li=document.createElement('li'); li.style.margin='6px 0';
          const id=`rt_${ch}_${(it.routine||'').replace(/\W+/g,'_')}`;
          li.innerHTML = `
            <label style="display:flex;align-items:center;gap:.5rem;cursor:pointer">
              <input type="checkbox" id="${id}" ${it.done?'checked':''}/>
              <span>${it.routine}</span>
            </label>`;
          ul.appendChild(li);
          li.querySelector('input').addEventListener('change', e=>{
            httpPost({ action:'routineTick', child: ch, routine: it.routine, done: e.target.checked ? 'true' : 'false' });
          });
        });
        box.appendChild(ul); wrap.appendChild(box);
      });
      this.el.innerHTML=''; this.el.appendChild(wrap);
    }
  };

  const Practice = {
    pools: {
      phonics: {
        1: ["cat","map","pin","log","sun","bed","cup","tap","dot","jam"],
        2: ["cap","men","nip","lot","sub","beg","cut","tip","pot","jet"],
        3: ["bim","lat","mog","tup","pev","naz","dut","lem","sib","wog"]
      }
    },
    mount(){
      this.ui = {
        child: document.getElementById('practiceChild'),
        mode: document.getElementById('practiceMode'),
        level: document.getElementById('practiceLevel'),
        start: document.getElementById('practiceStart'),
        area:  document.getElementById('practiceArea')
      };
      if (this.ui.start) this.ui.start.addEventListener('click', ()=> this.start());
    },
    start(){
      const child = this.ui.child?.value;
      const mode  = this.ui.mode?.value;
      const level = Number(this.ui.level?.value || 1);
      if (mode === 'phonics')  return this.playPhonics(child, level);
      if (mode === 'spellings')return this.playSpellings(child, level);
      if (mode === 'numbers')  return this.playNumbers(child, level);
    },
    playPhonics(child, level){
      const words = (this.pools.phonics[level]||[]).slice();
      let i=0, correct=0; const t0=Date.now();
      const maskOne = w => { const j=Math.floor(Math.random()*w.length); return w.split('').map((c,k)=>k===j?'_':c).join(''); };
      const next = ()=>{
        if (i>=words.length) return done();
        const w = words[i];
        const masked = (level===2) ? maskOne(w) : w;
        this.ui.area.innerHTML = `
          <h3>Phonics Level ${level}</h3>
          <p>Type the word ${level===2?'(one letter hidden)':''}:</p>
          <div style="font-size:2rem;letter-spacing:.1em">${masked}</div>
          <input id="ans" autofocus /> <button id="ok" class="btn primary">Check</button>`;
        const ans = this.ui.area.querySelector('#ans');
        this.ui.area.querySelector('#ok').onclick = ()=>{
          const a = (ans.value||'').trim().toLowerCase();
          const good = a === w;
          if (good) { try{ confetti({particleCount:40, spread:55, origin:{y:.7}});}catch(_){}} 
          httpPost({ action:'practiceLog', child, mode:'phonics', level:String(level), prompt:w, answer:a, correct: good?'1':'0', durationMs: String(Date.now()-t0) });
          i++; next();
        };
      };
      const done = ()=>{ this.ui.area.innerHTML = `<p>Done! Score: <strong>${correct}/${words.length}</strong></p>`; };
      next();
    },
    playSpellings(child, level){
      this.ui.area.innerHTML = `<p>Spellings Level ${level} coming next. Paste weekly list into a Sheet; API will serve pool.</p>`;
    },
    playNumbers(child, level){
      const buildSet = lvl => {
        const out=[], r=n=>Math.floor(Math.random()*n);
        if(lvl===1){ for(let i=0;i<10;i++){ const a=r(20), b=r(20-a); out.push({q:`${a} + ${b} = ?`, a:a+b}); } }
        if(lvl===2){ for(let i=0;i<10;i++){ const a=(r(10)+1)*2, b=r(6)*5; out.push({q:`${a} √ó 2 + ${b} = ?`, a:a*2+b}); } }
        if(lvl===3){ for(let i=0;i<10;i++){ const a=(r(12)+1)*3, b=r(12)+1; out.push({q:`${a} √∑ 3 + ${b} = ?`, a:a/3+b}); } }
        return out;
      };
      let qs=buildSet(level), i=0, correct=0; const t0=Date.now();
      const next=()=>{
        if(i>=qs.length) return done();
        const q=qs[i];
        this.ui.area.innerHTML = `
          <h3>Numbers Level ${level}</h3>
          <p>${q.q}</p>
          <input id="ans" autofocus /> <button id="ok" class="btn primary">Check</button>`;
        const ans=this.ui.area.querySelector('#ans');
        this.ui.area.querySelector('#ok').onclick=()=>{
          const a=Number(ans.value.trim()); const good=a===q.a;
          if (good) { try{ confetti({particleCount:40, spread:55, origin:{y:.7}});}catch(_){}} 
          httpPost({ action:'practiceLog', child, mode:'numbers', level:String(level), prompt:q.q, answer:String(a), correct: good?'1':'0', durationMs: String(Date.now()-t0) });
          i++; next();
        };
      };
      const done=()=>{ this.ui.area.innerHTML = `<p>Done! Score: <strong>${correct}/${qs.length}</strong></p>`; };
      next();
    }
  };

  window.addEventListener('load', ()=>{ Routine.mount(); Practice.mount(); });
  window.HomeLife.Routine = Routine; window.HomeLife.Practice = Practice;
})();
</script>

/* ========== Boot ========== */
window.addEventListener('load', () => {
  setInitialTheme();
  initQR();
  initCalendar();
  renderChoreButtons();
  loadSummary();
});
</script>
</body>
</html>
