<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Family Life Dashboard</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <!-- Cache-busted config. If you edit config.js again later, bump v=16,17,... -->
  <script>document.write('<script src="config.js?v='+(localStorage.getItem('configVersion')||'15')+'"><\/script>')</script>
  <script>
    // helper so you can force reload config after changing it (run in console: forceReloadConfig())
    window.forceReloadConfig = function(){ localStorage.setItem('configVersion', Date.now().toString()); location.reload(); };
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <style>
    :root { --bg: linear-gradient(to bottom right, red, orange, yellow, green, blue, indigo, violet); --text:#333; --section-bg:#fff; }
    body.dark { --bg:#111; --text:#f1f1f1; --section-bg:#222; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; background:var(--bg); color:var(--text); }
    header { background:rgba(255,255,255,.85); padding:1rem; text-align:center; font-weight:800; font-size:1.4rem; border-bottom:3px solid #fff; position:sticky; top:0; z-index:5 }
    .dark header { background:rgba(0,0,0,.8); border-bottom-color:#444; }
    section { background:var(--section-bg); margin:1rem; padding:1rem; border-radius:12px; box-shadow:0 0 10px rgba(0,0,0,.08); }
    details summary { cursor:pointer; font-weight:800; }
    h2,h3 { margin:.2rem 0 .6rem; }
    ul{ list-style:none; padding:0; margin:0; }
    li button, li a, .btn { display:inline-block; margin:4px 0; padding:.55rem 1rem; border:0; border-radius:10px; background:#2563eb; color:#fff; font-weight:700; cursor:pointer }
    li button:hover, .btn:hover { filter:brightness(.95); }
    .btn.secondary { background:#16a34a; }
    .btn.ghost { background:#334155; }
    .pill { display:inline-block; padding:.25rem .6rem; border-radius:999px; background:#e2e8f0; color:#0f172a; font-weight:800; font-size:.8rem }
    .toggle-mode { position:fixed; bottom:1rem; right:1rem; width:50px; height:50px; border-radius:50%; font-size:22px; border:0; box-shadow:0 2px 5px rgba(0,0,0,.3); cursor:pointer; z-index:20 }
    .toggle-mode.sun { background:#ffd700; color:#333 }
    .row { display:flex; gap:.75rem; flex-wrap:wrap; align-items:center }
    .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .progress { background:#e5e7eb; border-radius:999px; height:10px; overflow:hidden }
    .progress > div { background:linear-gradient(90deg,#22c55e,#16a34a); height:100%; width:0%; transition:width .4s }
    .earnings-badge { display:inline-block; min-width:3em; text-align:right; font-weight:800; color:#fff; border-radius:8px; padding:2px 8px }
    .badge-green{background:#22c55e}.badge-yellow{background:#f59e0b}.badge-orange{background:#f97316}.badge-grey{background:#64748b}
    .muted { color:#6b7280; }
    .card { border:1px solid #e5e7eb; border-radius:12px; padding:12px }
    /* Routine lock overlay */
    .lock { background:#0f172a; color:#fff; border-radius:12px; padding:12px; display:flex; align-items:center; justify-content:space-between; gap:12px }
    .lock small { opacity:.8 }
    /* Modal styles shared */
    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:50; align-items:center; justify-content:center; padding:1rem }
    .modal .content { background:var(--section-bg); color:var(--text); width:min(420px,92vw); border-radius:14px; box-shadow:0 6px 18px rgba(0,0,0,.35) }
    .modal .title { font-weight:900; padding:12px 16px; border-radius:14px 14px 0 0; background:linear-gradient(90deg,#4caf50,#81c784); color:#fff }
    .modal .body { padding:16px }
    .modal .actions { display:flex; gap:10px; justify-content:flex-end; padding:0 16px 16px }
    .modal input { width:100%; padding:10px 12px; border:1px solid #cbd5e1; border-radius:10px; font-size:16px }
    .task { display:flex; align-items:center; gap:10px; padding:10px 12px; border:1px solid #e5e7eb; border-radius:12px; margin:.35rem 0; cursor:pointer; }
    .task.done { background:#ecfdf5; border-color:#bbf7d0; text-decoration:line-through; opacity:.9 }
    .task .tick { font-weight:900; width:24px; text-align:center }
    .kicker{font-weight:800;color:#334155}
    .sep { height:1px; background:#e5e7eb; margin:10px 0 }
  </style>
</head>
<body>
  <header>üè° Family Life Dashboard</header>
  <button class="toggle-mode" id="modeToggle" onclick="toggleDarkMode()">üåô</button>

  <section>
    <details id="wifiSection">
      <summary>üì∂ Show Wi-Fi QR Code</summary>
      <div><canvas id="qrcode"></canvas></div>
    </details>
  </section>

  <section id="routineSection">
    <details open>
      <summary>üõå Bedtime and üïó Morning Routine</summary>

      <div id="lockBar" class="lock" style="display:none">
        <div>
          <div><strong>Locked</strong> ‚Äî complete your challenge to unlock.</div>
          <small>Parents can unlock below.</small>
        </div>
        <button class="btn" onclick="openUnlock()">Parent unlock</button>
      </div>

      <div id="routineWrap" style="display:none">
        <div class="row" style="justify-content:space-between">
          <div class="row">
            <span class="pill" id="whichMode">Bedtime</span>
            <span class="pill" id="progressLabel">0% done</span>
          </div>
          <div class="row">
            <button class="btn ghost" onclick="tellNext()">Tell me the next task</button>
            <button class="btn secondary" onclick="resetToday()">Reset today</button>
          </div>
        </div>

        <div id="routineList"></div>

        <div class="sep"></div>
        <div class="card">
          <div class="row" style="justify-content:space-between;align-items:center">
            <div>
              <div class="kicker">Tooth brushing timer</div>
              <div id="tbDisplay" style="font:900 28px/1 system-ui">2:00</div>
              <div class="muted" id="tbPrompt">Top, bottom, inside, outside. Gentle circles.</div>
            </div>
            <div class="row">
              <button class="btn" id="tbStart" onclick="tbStart()">Start</button>
              <button class="btn ghost" id="tbPause" onclick="tbPause()" disabled>Pause</button>
              <button class="btn" style="background:#ef4444" onclick="tbSkip()">Skip tonight</button>
            </div>
          </div>
        </div>
      </div>

    </details>
  </section>

  <section>
    <details>
      <summary>üßΩ Log a Chore</summary>
      <div id="choreLinks"></div>
    </details>
  </section>

  <section>
    <details open>
      <summary>üìà Weekly Chore Summary</summary>
      <div id="summaryContainer"></div>
    </details>
  </section>

  <section>
    <details>
      <summary>üìÖ Family Calendar</summary>
      <iframe id="calendarFrame" style="border:0;width:100%;height:400px" frameborder="0" scrolling="no"></iframe>
    </details>
  </section>

  <!-- Goal Modal -->
  <div id="goalModal" class="modal">
    <div class="content">
      <div class="title">Set Goal for <span id="modalChildName"></span></div>
      <div class="body">
        <label>Goal Name<input type="text" id="modalGoalName"/></label><br/><br/>
        <label>Goal Amount<input type="number" id="modalGoalAmount" inputmode="decimal"/></label>
      </div>
      <div class="actions">
        <button class="btn" onclick="submitGoal()">Submit</button>
        <button class="btn ghost" onclick="closeModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Chore Confirmation Modal -->
  <div id="choreConfirmModal" class="modal">
    <div class="content">
      <div class="title">Confirm Chore</div>
      <div class="body"><p id="choreConfirmText"></p></div>
      <div class="actions">
        <button class="btn" onclick="submitChore()">Yes, Submit</button>
        <button class="btn ghost" onclick="closeChoreModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Unlock Modal -->
  <div id="unlockModal" class="modal">
    <div class="content">
      <div class="title">Parent unlock</div>
      <div class="body">
        <p class="muted">Enter your code to enable the routine.</p>
        <input id="unlockCode" type="password" placeholder="PIN"/>
      </div>
      <div class="actions">
        <button class="btn" onclick="doUnlock()">Unlock</button>
        <button class="btn ghost" onclick="closeUnlock()">Cancel</button>
      </div>
    </div>
  </div>

<script>
/* ====== THEME ====== */
function toggleDarkMode(){
  const isDark = document.body.classList.toggle('dark');
  localStorage.setItem('theme', isDark ? 'dark' : 'light');
  document.getElementById('modeToggle').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
  document.getElementById('modeToggle').classList.toggle('sun', isDark);
}
function setInitialTheme(){
  const stored = localStorage.getItem('theme');
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  if (stored === 'dark' || (!stored && prefersDark)) {
    document.body.classList.add('dark');
    document.getElementById('modeToggle').textContent = '‚òÄÔ∏è';
    document.getElementById('modeToggle').classList.add('sun');
  }
}

/* ====== QR + CAL ====== */
function setupWifi(){
  try {
    new QRious({
      element: document.getElementById('qrcode'),
      size: 200,
      value: `WIFI:S:${window.config.wifiName};T:WPA;P:${window.config.wifiPassword};;`
    });
  } catch(e) { console.warn('QR init failed', e); }
}
function setupCalendar(){
  const id = encodeURIComponent(window.config.calendarEmail);
  document.getElementById('calendarFrame').src =
    `https://calendar.google.com/calendar/embed?showTitle=0&mode=AGENDA&wkst=1&height=400&bgcolor=%23ffffff&ctz=Europe%2FLondon&src=${id}`;
}

/* ====== GOALS ====== */
function openGoalModal(name){
  document.getElementById('modalChildName').textContent = name;
  document.getElementById('modalGoalName').value = window.fetchedData?.[name]?.goal || '';
  document.getElementById('modalGoalAmount').value = window.fetchedData?.[name]?.goalAmount || '';
  document.getElementById('goalModal').style.display = 'flex';
}
function closeModal(){ document.getElementById('goalModal').style.display = 'none'; }
function submitGoal(){
  const goalName = document.getElementById('modalGoalName').value;
  const goalAmount = document.getElementById('modalGoalAmount').value;
  const activeChildName = document.getElementById('modalChildName').textContent;
  if (!goalName || !goalAmount) return alert('Please enter both name and amount.');
  fetch(window.config.goalFormUrl, {
    method:'POST', mode:'no-cors',
    headers:{'Content-Type':'application/x-www-form-urlencoded'},
    body:`entry.1735294996=${encodeURIComponent(activeChildName)}&entry.1492747930=${encodeURIComponent(goalName)}&entry.795938275=${encodeURIComponent(goalAmount)}`
  });
  closeModal(); alert('Goal submitted!'); setTimeout(()=>location.reload(), 1200);
}

/* ====== CHORES ====== */
function stripDiacritics(s){ try { return s.normalize('NFD').replace(/[\u0300-\u036f]/g,''); } catch(e){ return s; } }
function nameForSheet(n){
  const s = stripDiacritics(String(n||'').trim());
  return (s.toLowerCase()==='m√©abh'||s.toLowerCase()==='meabh') ? 'Meabh' : s;
}
let activeChoreName='', activeChoreTask='';
function openChoreModal(name, chore){
  activeChoreName=name; activeChoreTask=chore;
  document.getElementById('choreConfirmText').textContent = `Did ${name} complete: "${chore}"?`;
  document.getElementById('choreConfirmModal').style.display='flex';
}
function closeChoreModal(){ document.getElementById('choreConfirmModal').style.display='none'; activeChoreName=''; activeChoreTask=''; }

function submitChore(){
  if (!activeChoreName || !activeChoreTask) return;
  const url = (window.config && window.config.choreSubmitUrl) || '';
  if (!url) { alert('Missing choreSubmitUrl in config'); return; }

  const p = new URLSearchParams();
  p.set('child', nameForSheet(activeChoreName));
  p.set('chore', activeChoreTask);
  p.set('ts', String(Date.now()));
  const body = p.toString();

  let sent=false;
  if (navigator.sendBeacon){
    try { sent = navigator.sendBeacon(url, new Blob([body], {type:'application/x-www-form-urlencoded'})); } catch(e){}
  }
  if (!sent){
    fetch(url, { method:'POST', mode:'no-cors', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body }).catch(()=>{});
  }
  closeChoreModal(); alert('Chore submitted!'); setTimeout(()=>location.reload(), 1000);
}

/* ====== SUMMARY ====== */
function badgeClass(weekly){
  if (weekly >= 5) return 'badge-green';
  if (weekly === 3) return 'badge-yellow';
  if (weekly === 1) return 'badge-orange';
  return 'badge-grey';
}
function renderSummary(data){
  window.fetchedData = data;
  const container = document.getElementById('summaryContainer');
  container.innerHTML = '';
  Object.entries(data).forEach(([name, person])=>{
    if (!person) return;
    const id = name === 'Robin' ? 'robin' : 'meabh';
    const weekly = Number(person.weekly||0);
    const total  = Number(person.total||0);
    const goal   = String(person.goal||'');
    const goalAmt= Number(person.goalAmount||0);
    const progress = goalAmt>0 ? Math.min((total/goalAmt)*100,100) : 0;

    const card = document.createElement('div');
    card.className='card'; card.style.margin='10px 0';
    card.innerHTML = `
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:.2rem 0">${name}</h3>
        <span class="earnings-badge ${badgeClass(weekly)}">¬£${weekly.toFixed(2)}</span>
      </div>
      <div class="row muted">Chores completed this week: <strong id="${id}Count">${person.count??0}</strong></div>
      <div class="row muted">üéØ Goal: <strong>${goal||'‚Äî'}</strong> (¬£${goalAmt||'‚Äî'})</div>
      <div class="progress"><div id="${id}Goal" style="width:${progress}%"></div></div>
      <div class="row" style="justify-content:space-between;margin-top:6px">
        <div>Total so far: <strong>¬£<span id="${id}Total">${total.toFixed(2)}</span></strong></div>
        <button class="btn" onclick="openGoalModal('${name}')">Set Goal</button>
      </div>`;
    container.appendChild(card);

    if (weekly >= 5) try { confetti(); } catch(_){}
  });
}

/* ====== ROUTINE (auto-switch + lock + timer) ====== */
const BEDTIME_TASKS = [
  'Get undressed',
  'Get washed',
  'Clean teeth',
  'Get pyjamas on',
  'Robin: cream & inhaler',
  'Get clothes out for tomorrow',
  'Choose a book',
  'Last wee',
  'Set clocks',
  'Settled in bed'
];
const MORNING_TASKS = [
  'Get dressed',
  'Down to breakfast (07:45)',
  'Clean teeth (08:10)',
  'Sort bags (bottle/lunch/books ‚Äì Tue: Robin guitar)',
  'Shoes & coats (08:20)',
  'In the car (08:25)'
];

let routineState = { mode:'bed', done: {} };
function currentModeFromTime(){
  const now = new Date();
  const h = now.getHours();
  // morning 05:00‚Äì10:00, bedtime from 17:00 onwards, else default to bedtime
  if (h>=5 && h<10) return 'morning';
  if (h>=17 || h<5) return 'bed';
  return 'bed';
}
function loadRoutine(){
  const unlocked = localStorage.getItem('routineUnlocked') === '1' || (window.config && window.config.defaultUnlocked===true);
  document.getElementById('lockBar').style.display = unlocked ? 'none':'flex';
  document.getElementById('routineWrap').style.display = unlocked ? 'block':'none';

  routineState.mode = currentModeFromTime();
  routineState.done = JSON.parse(localStorage.getItem('routineDone')||'{}');
  renderRoutine();
}
function renderRoutine(){
  const mode = routineState.mode;
  const tasks = (mode==='bed') ? BEDTIME_TASKS.slice() : MORNING_TASKS.slice();
  // Hide mode-specific tasks
  const filtered = tasks.filter(t=>{
    if (mode==='bed' && t.startsWith('Robin:') && !window.config?.showRobinMedical) return false;
    if (mode==='bed' && t==='Set clocks' && window.config?.hideSetClocks) return false;
    return true;
  });

  const el = document.getElementById('routineList'); el.innerHTML='';
  const keyPrefix = (mode==='bed' ? 'b:' : 'm:');
  let doneCount = 0;

  filtered.forEach(task=>{
    const key = keyPrefix + task;
    const isDone = !!routineState.done[key];
    if (isDone) doneCount++;
    const row = document.createElement('div');
    row.className = 'task' + (isDone ? ' done' : '');
    row.onclick = ()=>{ routineState.done[key] = !routineState.done[key]; saveRoutine(); renderRoutine(); };
    row.innerHTML = `<div class="tick">${isDone ? '‚úì' : ''}</div><div>${task}</div>`;
    el.appendChild(row);
  });

  const pct = filtered.length ? Math.round((doneCount/filtered.length)*100) : 0;
  document.getElementById('whichMode').textContent = (mode==='bed' ? 'Bedtime' : 'Morning');
  document.getElementById('progressLabel').textContent = `${pct}% done`;
}
function saveRoutine(){ localStorage.setItem('routineDone', JSON.stringify(routineState.done)); }
function tellNext(){
  const mode = routineState.mode;
  const tasks = (mode==='bed') ? BEDTIME_TASKS : MORNING_TASKS;
  const keyPrefix = (mode==='bed' ? 'b:' : 'm:');
  const next = tasks.find(t => !routineState.done[keyPrefix+t]);
  alert(next ? `Next up: ${next}` : 'All done ‚Äì nice work!');
}
function resetToday(){ routineState.done={}; saveRoutine(); renderRoutine(); }

/* ---- Lock / Unlock ---- */
function openUnlock(){ document.getElementById('unlockModal').style.display='flex'; }
function closeUnlock(){ document.getElementById('unlockModal').style.display='none'; }
function doUnlock(){
  const code = (document.getElementById('unlockCode').value || '').trim();
  if (String(code) === String(window.config.parentPin||'')) {
    localStorage.setItem('routineUnlocked','1');
    closeUnlock(); loadRoutine();
  } else {
    alert('Wrong code');
  }
}

/* ---- Tooth brushing timer (no streaks, no weird loops) ---- */
let tbTimer=null, tbRemain=120, tbRunning=false;
function tbRender(){
  const m = Math.floor(tbRemain/60), s = tbRemain%60;
  document.getElementById('tbDisplay').textContent = `${m}:${String(s).padStart(2,'0')}`;
  document.getElementById('tbPause').disabled = !tbRunning;
}
function tbStart(){
  if (tbRunning) return;
  tbRunning=true; tbRender();
  tbTimer = setInterval(()=>{
    if (tbRemain<=0){ tbStop(true); return; }
    tbRemain--; tbRender();
  }, 1000);
}
function tbPause(){
  if (!tbRunning) return;
  clearInterval(tbTimer); tbTimer=null; tbRunning=false; tbRender();
}
function tbSkip(){
  tbPause(); tbRemain=120; tbRender(); alert('Skipping tooth brushing timer tonight.');
}
function tbStop(done){
  tbPause();
  if (done){ try { confetti(); } catch(_){} alert('Nice brushing!'); }
  tbRemain=120; tbRender();
}

/* ====== INIT ====== */
window.onload = ()=>{
  // open Wi-Fi QR the first ever time
  if (!localStorage.getItem('seenQR')) {
    document.getElementById('wifiSection').setAttribute('open','');
    localStorage.setItem('seenQR','1');
  }
  setInitialTheme(); setupWifi(); setupCalendar();

  // chores list
  const chores = {
    'Robin': ['Tidy Room','Empty/Refill Dishwasher','Set the Table','Help with the Washing','House Cleaning','Other'],
    'M√©abh': ['Tidy Room','Empty/Refill Dishwasher','Set the Table','Help with the Washing','House Cleaning','Other']
  };
  const wrap = document.getElementById('choreLinks');
  wrap.innerHTML='';
  Object.keys(chores).forEach(name=>{
    const h = document.createElement('div'); h.innerHTML = `<h3>${name}</h3>`;
    const ul = document.createElement('ul');
    chores[name].forEach(ch=>{
      const li=document.createElement('li');
      li.innerHTML=`<button onclick="openChoreModal('${name}','${ch}')">${ch}</button>`;
      ul.appendChild(li);
    });
    h.appendChild(ul); wrap.appendChild(h);
  });

  // summary fetch (Apps Script GET)
  const url = window.config.summaryUrl; // e.g. your JSON endpoint
  fetch(url).then(r=>r.json()).then(renderSummary).catch(err=>{
    console.error('Summary load failed', err);
    document.getElementById('summaryContainer').innerHTML =
      '<div class="muted">Could not load weekly summary.</div>';
  });

  // routine (lock + mode)
  loadRoutine();
};
</script>
</body>
</html>
