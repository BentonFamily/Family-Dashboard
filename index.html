<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Family Life Dashboard</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <script src="config.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <style>
    :root {
      --bg: linear-gradient(to bottom right, red, orange, yellow, green, blue, indigo, violet);
      --text: #333;
      --section-bg: white;
    }
    body.dark { --bg: #111; --text: #f1f1f1; --section-bg: #222; }
    body { font-family: sans-serif; margin: 0; padding: 0; background: var(--bg); color: var(--text); }
    header { background: rgba(255, 255, 255, 0.8); padding: 1rem; text-align: center; font-size: 1.5rem; font-weight: bold; border-bottom: 3px solid #fff; position: relative; z-index: 1; }
    .dark header { background: rgba(0, 0, 0, 0.8); border-bottom: 3px solid #444; }
    section { background: var(--section-bg); margin: 1rem; padding: 1rem; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    h2, h3 { color: var(--text); }
    ul { list-style: none; padding-left: 0; }
    li a, li button { display: inline-block; margin: 4px 0; padding: 0.5rem 1rem; font-size: 1rem; border: none; border-radius: 6px; background: #81c784; color: white; cursor: pointer; text-decoration: none; transition: background 0.3s; }
    li a:hover, li button:hover { background: #66bb6a; }
    body.dark li a, body.dark li button { background: #388e3c; }
    body.dark li a:hover, body.dark li button:hover { background: #2e7d32; }
    .toggle-mode { position: fixed; bottom: 1rem; right: 1rem; width: 50px; height: 50px; background: #000; color: #fff; border: none; border-radius: 50%; font-size: 24px; cursor: pointer; z-index: 999; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.3); transition: background 0.3s, transform 0.3s; }
    .toggle-mode.sun { background: #ffd700; color: #333; }
    .qr-output { margin-top: 1rem; }
    details summary { font-weight: bold; cursor: pointer; margin-bottom: 1rem; }
    .chore-summary h3 { margin-top: 1rem; color: #555; }
    body.dark .chore-summary h3 { color: #f1f1f1; }
    .earnings-badge { display: inline-block; min-width: 3em; text-align: right; font-weight: bold; color: white; border-radius: 5px; padding: 2px 8px; }
    .badge-green { background-color: #2ecc71; }
    .badge-yellow { background-color: #f1c40f; }
    .badge-orange { background-color: #e67e22; }
    .badge-grey { background-color: #7f8c8d; }
    .progress-bar { background: #ddd; border-radius: 10px; overflow: hidden; margin-top: 0.5rem; height: 20px; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #2ecc71, #27ae60); width: 0%; transition: width 0.5s ease; }
    #goalModal input { width: calc(100% - 16px); padding: 8px; margin-top: 4px; margin-bottom: 10px; margin-left: 0; margin-right: 0; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; background: white; color: black; }
    #goalModal label { font-weight: bold; display: block; margin-bottom: 5px; }
    #goalModal .modal-content, #choreConfirmModal .modal-content { background: var(--section-bg); color: var(--text); padding: 20px; border-radius: 12px; width: 90%; max-width: 400px; box-shadow: 0 2px 10px rgba(0,0,0,0.25); position: relative; }
    #goalModal .modal-title, #choreConfirmModal .modal-title { font-size: 1.2rem; font-weight: bold; background: linear-gradient(to right, #4caf50, #81c784); color: white; padding: 10px 15px; border-radius: 8px 8px 0 0; margin: -20px -20px 20px -20px; text-align: center; }

    /* ===================== Routine component (scoped styles) ===================== */
    .routine { --muted:#5b6b7b; --text:#0f172a; --pill1:#ef4444; --pill2:#f59e0b; --pill3:#eab308; --pill4:#22c55e; --pill5:#3b82f6; --pill6:#a855f7; }
    .dark .routine { --text:#e2e8f0; --muted:#94a3b8; }
    .routine .header { display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:12px; }
    .routine .title { font-size: clamp(22px, 4vw, 28px); font-weight: 800; color: var(--text); }
    .routine .tabs, .routine .kid-tabs { display:flex; gap:8px; flex-wrap:wrap; }
    .routine .pill { border:1px solid #d1d5db; background:#f9fafb; padding:8px 12px; border-radius:999px; color:#374151; cursor:pointer; user-select:none; font-weight:600; }
    .dark .routine .pill { border-color:#374151; background:#0b1020; color:#cbd5e1; }
    .routine .pill.active { color:#0b1020; background:linear-gradient(90deg, var(--pill1), var(--pill3)); border-color:transparent; }
    .dark .routine .pill.active { color:#0b1020; }

    .routine .progress { margin:10px 0 14px; background:#f3f4f6; border:1px solid #e5e7eb; border-radius:999px; padding:6px; position:relative }
    .dark .routine .progress { background:#0b1020; border-color:#1f2937; }
    .routine .bar { height:14px; border-radius:999px; width:0%; background:linear-gradient(90deg, var(--pill1), var(--pill2), var(--pill3), var(--pill4), var(--pill5), var(--pill6)); transition:width .25s ease }
    .routine .progress-label { position:absolute; top:-22px; right:0; font-size:12px; color:var(--muted) }

    .routine .nudge { background:#f9fafb; border:1px dashed #cbd5e1; color:#374151; padding:10px 12px; border-radius:12px; font-size:14px }
    .dark .routine .nudge { background:#0b1020; border-color:#263044; color:#94a3b8 }
    .routine .nudge strong{ color:var(--text) }

    .routine .grid { display:grid; gap:10px }
    .routine .card { background:linear-gradient(180deg, rgba(0,0,0,.02), rgba(0,0,0,.01)); border:1px solid rgba(0,0,0,.06); border-radius:16px; padding:12px; display:flex; align-items:center; gap:12px }
    .dark .routine .card { border-color:rgba(255,255,255,.08); background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)) }
    .routine .idx { width:34px; height:34px; display:grid; place-items:center; border-radius:10px; font-weight:800; background:linear-gradient(120deg, var(--pill2), var(--pill4)); color:white }
    .routine .task { flex:1 }
    .routine .name { font-weight:800; font-size:18px; color:var(--text) }
    .routine .desc { color:var(--muted); font-size:13px; margin-top:2px }
    .routine .tick { width:44px; height:44px; border-radius:12px; border:2px solid #e5e7eb; background:#fff; display:grid; place-items:center; cursor:pointer }
    .dark .routine .tick { border-color:#1f2937; background:#0b1020 }
    .routine .tick.done { background:linear-gradient(120deg, #16a34a, #22c55e); border-color:#16a34a }
    .routine .tick svg { width:22px; height:22px; opacity:.9; filter:drop-shadow(0 1px 2px rgba(0,0,0,.35)) }

    .routine .footer { display:flex; gap:10px; margin-top:12px; flex-wrap:wrap }
    .routine .btn { appearance:none; border:none; padding:10px 14px; border-radius:12px; font-weight:800; cursor:pointer }
    .routine .btn.primary { background:linear-gradient(90deg, var(--pill4), var(--pill5)); color:#06121c }
    .routine .btn.ghost { background:#f9fafb; border:1px solid #e5e7eb; color:#374151 }
    .dark .routine .btn.ghost { background:#0b1020; border-color:#1f2937; color:#94a3b8 }
    .routine .streak { margin-left:auto; background:linear-gradient(120deg, #f59e0b, #ef4444); color:#fff; padding:10px 12px; border-radius:12px; font-weight:900 }

    /* Brush Timer Modal */
    #brushTimerModal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:1000; align-items:center; justify-content:center }
    #brushTimerModal .box { background:var(--section-bg); color:var(--text); width: min(92vw, 420px); border-radius:16px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.35); text-align:center; }
    #brushTimerModal h3 { margin-top:0; }
    #brushTimerModal .dial { width:220px; height:220px; margin:10px auto; display:block }
    #brushTimerModal .big { font-size: 44px; font-weight: 900; letter-spacing:1px; }
    #brushTimerModal .sub { color:#6b7280; margin-top:4px }
    #brushTimerModal .actions { display:flex; gap:10px; justify-content:center; margin-top:12px; flex-wrap:wrap }
    #brushTimerModal button { border:none; border-radius:10px; padding:10px 14px; font-weight:800; cursor:pointer }
    #brushTimerModal .start { background:linear-gradient(90deg, #22c55e, #3b82f6); color:#06121c }
    #brushTimerModal .pause { background:#f3f4f6 }
    #brushTimerModal .skip { background:#fee2e2 }

    /* Big friendly targets */
    @media (pointer: coarse){ .routine .card{padding:16px} .routine .tick{width:56px; height:56px} .routine .name{font-size:19px} }
  </style>
</head>
<body>
  <header>üè° Family Life Dashboard</header>
  <button class="toggle-mode" onclick="toggleDarkMode()" id="modeToggle">üåô</button>

  <section>
    <details id="wifiSection">
      <summary>üì∂ Show Wi‚ÄëFi QR Code</summary>
      <div class="qr-output"><canvas id="qrcode"></canvas></div>
    </details>
  </section>

  <!-- ===================== Bedtime & Morning Routine (New) ===================== -->
  <section>
    <details open>
      <summary>üõå Bedtime & üåÖ Morning Routine</summary>
      <div class="routine" id="routineRoot">
        <div class="header">
          <div class="title" id="routineTitle">Bedtime</div>
          <div class="kid-tabs" id="kidTabs"></div>
          <div class="tabs" id="routineTabs"></div>
        </div>
        <div class="progress"><div class="progress-label" id="routineProgressLabel">0% done</div><div class="bar" id="routineBar"></div></div>
        <div class="nudge" id="routineNudge">Next up: <strong>Tap a task to begin</strong></div>
        <div class="grid" id="routineList"></div>
        <div class="footer">
          <button class="btn primary" id="routineSpeakNext">Tell me the next task</button>
          <button class="btn ghost" id="routineReset">Reset today</button>
          <div class="streak" id="routineStreak">üî• 0‚Äëday streak</div>
        </div>
      </div>
      <canvas id="routineConfetti" style="position:fixed;inset:0;pointer-events:none"></canvas>
    </details>
  </section>

  <!-- ===================== Existing dashboard sections ===================== -->
  <section>
    <details>
      <summary>üßΩüßπüßºüëñüëóüëö Log a Chore</summary>
      <ul id="choreLinks"></ul>
    </details>
  </section>

  <section>
    <details open>
      <summary>üìà Weekly Chore Summary</summary>
      <div class="chore-summary" id="summaryContainer"></div>
    </details>
  </section>

  <section>
    <details>
      <summary>üìÖ Family Calendar</summary>
      <iframe id="calendarFrame" style="border: 0; width: 100%; height: 400px;" frameborder="0" scrolling="no"></iframe>
    </details>
  </section>

  <!-- Goal Modal (existing) -->
  <div id="goalModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000; align-items:center; justify-content:center;">
    <div class="modal-content">
      <div class="modal-title">Set Goal for <span id="modalChildName"></span></div>
      <p><label>Goal Name: <input type="text" id="modalGoalName" /></label></p>
      <p><label>Goal Amount: <input type="number" id="modalGoalAmount" inputmode="decimal" /></label></p>
      <button onclick="submitGoal()">Submit</button>
      <button onclick="closeModal()" style="margin-left:10px;">Cancel</button>
    </div>
  </div>

  <!-- Chore Confirmation Modal (existing) -->
  <div id="choreConfirmModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000; align-items:center; justify-content:center;">
    <div class="modal-content">
      <div class="modal-title">Confirm Chore</div>
      <p id="choreConfirmText"></p>
      <button onclick="submitChore()">Yes, Submit</button>
      <button onclick="closeChoreModal()" style="margin-left:10px;">Cancel</button>
    </div>
  </div>

  <!-- Brush Timer Modal (new) -->
  <div id="brushTimerModal">
    <div class="box">
      <h3>ü™• Tooth‚Äëbrushing timer</h3>
      <svg viewBox="0 0 120 120" class="dial" aria-hidden="true">
        <circle cx="60" cy="60" r="52" fill="none" stroke="#e5e7eb" stroke-width="12"/>
        <circle id="brushDialFill" cx="60" cy="60" r="52" fill="none" stroke="#22c55e" stroke-width="12" stroke-linecap="round"
                stroke-dasharray="326.725635" stroke-dashoffset="326.725635" transform="rotate(-90 60 60)"/>
      </svg>
      <div class="big" id="brushTime">2:00</div>
      <div class="sub">Top, bottom, inside, outside. Gentle circles.</div>
      <div class="actions">
        <button class="start" id="brushStart">Start</button>
        <button class="pause" id="brushPause" disabled>Pause</button>
        <button class="skip" id="brushSkip">Skip tonight</button>
      </div>
    </div>
  </div>

<script>
// ==================== Theme & existing dashboard logic (unchanged) ====================
function toggleDarkMode() {
  const isDark = document.body.classList.toggle("dark");
  localStorage.setItem("theme", isDark ? "dark" : "light");
  document.getElementById("modeToggle").textContent = isDark ? "‚òÄÔ∏è" : "üåô";
  document.getElementById("modeToggle").classList.toggle("sun", isDark);
}
function setInitialTheme() {
  const storedTheme = localStorage.getItem("theme");
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  const useDark = storedTheme === "dark" || (!storedTheme && prefersDark);
  if (useDark) {
    document.body.classList.add("dark");
    document.getElementById("modeToggle").textContent = "‚òÄÔ∏è";
    document.getElementById("modeToggle").classList.add("sun");
  }
}
function openGoalModal(name) {
  document.getElementById("modalChildName").textContent = name;
  document.getElementById("modalGoalName").value = window.fetchedData?.[name]?.goal || "";
  document.getElementById("modalGoalAmount").value = window.fetchedData?.[name]?.goalAmount || "";
  document.getElementById("goalModal").style.display = "flex";
}
function closeModal() { document.getElementById("goalModal").style.display = "none"; }
function submitGoal() {
  const goalName = document.getElementById("modalGoalName").value;
  const goalAmount = document.getElementById("modalGoalAmount").value;
  const activeChildName = document.getElementById("modalChildName").textContent;
  if (!goalName || !goalAmount) return alert("Please enter both name and amount.");
  fetch("https://docs.google.com/forms/d/e/1FAIpQLScVdXH2oenWvUsINA6IcmxvomWoiGKFG0uHO85NUWEmiFHDTg/formResponse", {
    method: "POST", mode: "no-cors", headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: `entry.1735294996=${encodeURIComponent(activeChildName)}&entry.1492747930=${encodeURIComponent(goalName)}&entry.795938275=${encodeURIComponent(goalAmount)}`
  });
  closeModal(); alert("Goal submitted!"); setTimeout(() => location.reload(), 2000);
}
let activeChoreName = ""; let activeChoreTask = "";
function openChoreModal(name, chore) {
  activeChoreName = name; activeChoreTask = chore;
  document.getElementById("choreConfirmText").textContent = `Did ${name} complete: "${chore}"?`;
  document.getElementById("choreConfirmModal").style.display = "flex";
}
function closeChoreModal() { document.getElementById("choreConfirmModal").style.display = "none"; activeChoreName = ""; activeChoreTask = ""; }
function submitChore() {
  if (!activeChoreName || !activeChoreTask) return;
  const formURL = "https://docs.google.com/forms/d/e/1FAIpQLSeYUTDpIZeLTm0wzBeEE1csm_80hKFrbvUsHzxOkz_C2er8yA/formResponse";
  fetch(formURL, { method: "POST", mode: "no-cors", headers: { "Content-Type": "application/x-www-form-urlencoded" }, body: `entry.2076450991=${encodeURIComponent(activeChoreName)}&entry.1927254214=${encodeURIComponent(activeChoreTask)}` });
  closeChoreModal(); alert("Chore submitted!"); setTimeout(() => location.reload(), 1500);
}
window.onload = () => {
  if (!localStorage.getItem("seenQR")) { document.getElementById("wifiSection").setAttribute("open", ""); localStorage.setItem("seenQR", "true"); }
  setInitialTheme();
  new QRious({ element: document.getElementById("qrcode"), size: 200, value: `WIFI:S:${window.config.wifiName};T:WPA;P:${window.config.wifiPassword};;` });
  document.getElementById("calendarFrame").src = "https://calendar.google.com/calendar/embed?src=" + encodeURIComponent(window.config.calendarEmail) + "&ctz=Europe%2FLondon";
  const chores = { "Robin": ["Tidy Room", "Empty/Refill Dishwasher", "Set the Table", "Help with the Washing", "House Cleaning", "Other"], "M√©abh": ["Tidy Room", "Empty/Refill Dishwasher", "Set the Table", "Help with the Washing", "House Cleaning", "Other"] };
  const choreList = document.getElementById("choreLinks");
  for (const name in chores) {
    choreList.innerHTML += `<h3>${name}</h3><ul style='list-style: none; padding: 0;'>`;
    chores[name].forEach(chore => { choreList.innerHTML += `<li><button onclick=\"openChoreModal('${name}', '${chore}')\">${chore}</button></li>`; });
    choreList.innerHTML += `</ul>`;
  }
  fetch("https://script.google.com/macros/s/AKfycbwBIGo4EnzoGMU7y6jG7VITAiH6o0aVnQr9rlO9IQ6GdXlwz9eOyw0x5nfP1bEkEfLNzg/exec")
    .then(res => res.json())
    .then(data => {
      window.fetchedData = data; const container = document.getElementById("summaryContainer");
      Object.entries(data).forEach(([name, person]) => {
        const id = name === "Robin" ? "robin" : "meabh"; if (!person) return;
        container.innerHTML += `
          <h3>${name}</h3>
          <p>Chores completed this week: <span id="${id}Count">${person.count ?? 0}</span></p>
          <p>Weekly earnings: ¬£<span id="${id}Earnings" class="earnings-badge">${(person.weekly ?? 0).toFixed(2)}</span></p>
          <p>üéØ Goal: <span>${person.goal || "‚Äî"}</span> (¬£<span>${person.goalAmount || "‚Äî"}</span>)</p>
          <div class="progress-bar"><div id="${id}Goal" class="progress-fill"></div></div>
          <p>Total so far: ¬£<span id="${id}Total">${(person.total ?? 0).toFixed(2)}</span></p>
          <button onclick="openGoalModal('${name}')">Set Goal</button>
        `;
        const fill = document.getElementById(`${id}Goal`);
        const goal = parseFloat(person.goalAmount) || 0; const total = parseFloat(person.total) || 0; const progress = goal > 0 ? Math.min((total / goal) * 100, 100) : 0; fill.style.width = `${progress}%`;
        const badge = document.getElementById(`${id}Earnings`);
        badge.classList.remove("badge-green", "badge-yellow", "badge-orange", "badge-grey");
        if (person.weekly >= 5) badge.classList.add("badge-green");
        else if (person.weekly === 3) badge.classList.add("badge-yellow");
        else if (person.weekly === 1) badge.classList.add("badge-orange");
        else badge.classList.add("badge-grey");
        if (person.weekly >= 5) confetti();
      });
    });
};

// ==================== Routine component (isolated scope) ====================
(() => {
  const R = {
    dailyResetHour: 4,
    speakEnabled: true,
    confettiEnabled: true,
    streaksEnabled: false,
    defaultChild: 'Robin',
    auto: { enable: true, bedHour: 17 },
    // PE schedule + activities
    school: {
      peDays: {
        'Robin': { Tue: 'Outdoor PE', Wed: 'Indoor PE' },
        'M√©abh': { Thu: 'Outdoor PE', Fri: 'Indoor PE' }
      },
      guitar: { 'Robin': ['Tue'] }
    },
    routines: {
      bed: [
        { id:'undress', name:'Get undressed' },
        { id:'wash', name:'Get washed', desc:'Face, pits & bits ‚Äî or shower/bath' },
        { id:'teeth', name:'Clean teeth', desc:'Two minutes' },
        { id:'pjs', name:'Get pyjamas on' },
        { id:'cream-inhaler', name:'Cream & inhaler', onlyFor:['Robin'] },
        { id:'clothes-out', name:'Get clothes out for tomorrow' },
        { id:'book', name:'Choose a book' },
        { id:'last-wee', name:'Last wee' },
        { id:'set-clocks', name:'Set clocks', onlyFor:['Robin'] },
        { id:'settle', name:'Settled in bed' }
      ],
      morning: [
        { id:'get-dressed', name:'Get dressed', desc:'Tablet unlocks after this' },
        { id:'breakfast', name:'Down to breakfast', desc:'Aim for 07:45' },
        { id:'teeth-am', name:'Clean teeth', desc:'08:10' },
        { id:'bags', name:'Sort bags', desc:'Bottle, lunch, books' },
        { id:'shoes-coats', name:'Shoes & coats', desc:'08:20' },
        { id:'leave', name:'In the car to leave', desc:'08:25' }
      ]
    },
    sync: { enabled: false, endpoint: '' }
  };

  // ----- State -----
  const qs = new URLSearchParams(location.search);
  let currentChild = localStorage.getItem('routine:lastChild') || qs.get('child') || R.defaultChild;
  let manualOverrideUntil = +(localStorage.getItem('routine:overrideUntil')||0);
  let currentRoutine = (qs.get('routine') || autoRoutineNow()).toLowerCase();
  if (qs.get('routine')) { setManualOverrideUntilNextBoundary(); }

  const el = (id) => document.getElementById(id);
  const listEl = el('routineList');
  const nudgeEl = el('routineNudge');
  const barEl = el('routineBar');
  const progressLabel = el('routineProgressLabel');
  const titleEl = el('routineTitle');
  const streakEl = el('routineStreak');
  if(streakEl && !R.streaksEnabled){ streakEl.style.display='none'; }
  const tabsEl = el('routineTabs');
  const kidTabsEl = el('kidTabs');
  const confettiCanvas = el('routineConfetti');
  const confettiCtx = confettiCanvas.getContext('2d');

  function key(){ return `routine:${currentChild}:${currentRoutine}:${todayKey()}`; }
  function streakKey(){ return `routine-streak:${currentChild}:${currentRoutine}`; }
  function todayKey(){ const now = new Date(); if(now.getHours() < R.dailyResetHour){ now.setDate(now.getDate()-1); } return now.toISOString().slice(0,10); }
  function loadProgress(){ try{ return JSON.parse(localStorage.getItem(key())||'{}'); }catch{return{}} }
  function saveProgress(p){ localStorage.setItem(key(), JSON.stringify(p)); }
  function getStreak(){ if(!R.streaksEnabled) return 0; return +(localStorage.getItem(streakKey())||0); }
  function setStreak(n){ if(!R.streaksEnabled) return; localStorage.setItem(streakKey(), String(n)); }

  function visibleTasksForChild(list){ return list.filter(t=>{ if(t.onlyFor) return t.onlyFor.includes(currentChild); if(t.excludeFor) return !t.excludeFor.includes(currentChild); return true; }).map(t=>({...t})); }
  function tomorrowLabel(){ const d=new Date(); d.setDate(d.getDate()+1); return d.toLocaleDateString(undefined,{ weekday:'long'}); }
  function clothesOutDesc(){ const tomorrow=new Date(); tomorrow.setDate(tomorrow.getDate()+1); const dayShort=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][tomorrow.getDay()]; const pe=R.school.peDays[currentChild]?.[dayShort]; return pe ? `${tomorrowLabel()} is ${pe} ‚Äî add PE kit` : `Ready for ${tomorrowLabel()}`; }
  function bagsDesc(){ const today=new Date(); const dayShort=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][today.getDay()]; const guitar=R.school.guitar[currentChild]?.includes(dayShort) ? ' + Guitar' : ''; return `Bottle, lunch, books${guitar}`; }

  function renderTabs(){
    tabsEl.innerHTML = '';
    [['bed','Bedtime'],['morning','Morning']].forEach(([val,label])=>{
      const b=document.createElement('div'); b.className='pill'+(currentRoutine===val?' active':''); b.textContent=label; b.addEventListener('click',()=>{ currentRoutine=val; setManualOverrideUntilNextBoundary(); render(); }); tabsEl.appendChild(b);
    });
    kidTabsEl.innerHTML = '';
    ['Robin','M√©abh'].forEach(name=>{ const b=document.createElement('div'); b.className='pill'+(currentChild===name?' active':''); b.textContent=name; b.addEventListener('click',()=>{ setChild(name); }); kidTabsEl.appendChild(b); });
  }
  function setChild(name){ currentChild=name; localStorage.setItem('routine:lastChild', name); saveProgress(loadProgress()); renderTabs(); render(); }

  function autoRoutineNow(){
    const now = new Date(); const h = now.getHours();
    const bedH = R.auto?.bedHour ?? 17; const resetH = R.dailyResetHour;
    // Morning between reset and bed; Bed otherwise
    return (h >= resetH && h < bedH) ? 'morning' : 'bed';
  }
  function nextAutoBoundaryTS(){
    const now = new Date(); const h = now.getHours();
    const bedH = R.auto?.bedHour ?? 17; const resetH = R.dailyResetHour;
    const t = new Date(now);
    if (h < resetH) { t.setHours(resetH,0,0,0); return +t; }
    if (h < bedH) { t.setHours(bedH,0,0,0); return +t; }
    // after bedHour -> next day's reset
    t.setDate(t.getDate()+1); t.setHours(resetH,0,0,0); return +t;
  }
  function setManualOverrideUntilNextBoundary(){
    manualOverrideUntil = nextAutoBoundaryTS();
    localStorage.setItem('routine:overrideUntil', String(manualOverrideUntil));
  }
  function shouldAutoSwitch(){
    if (!R.auto?.enable) return false;
    return Date.now() >= (manualOverrideUntil||0);
  }

  function render(){
    const tasks = visibleTasksForChild(R.routines[currentRoutine]);
    titleEl.textContent = currentRoutine === 'bed' ? 'Bedtime' : 'Morning';
    tasks.forEach(t=>{ if(t.id==='clothes-out'){ t.desc = clothesOutDesc(); } if(t.id==='bags'){ t.desc = bagsDesc(); } });
    listEl.innerHTML = '';
    const progress = loadProgress();
    tasks.forEach((t,i)=>{
      const card=document.createElement('div'); card.className='card'; card.dataset.id=t.id;
      const idx=document.createElement('div'); idx.className='idx'; idx.textContent=i+1;
      const task=document.createElement('div'); task.className='task';
      const name=document.createElement('div'); name.className='name'; name.textContent=t.name;
      const desc=document.createElement('div'); desc.className='desc'; desc.textContent=t.desc||'';
      task.append(name); if(t.desc) task.append(desc);
      const tick=document.createElement('button'); tick.className='tick'; tick.setAttribute('aria-label',`Toggle ${t.name}`); tick.innerHTML = svgTick();
      if(progress[t.id]) tick.classList.add('done');
      tick.addEventListener('click', ()=> onToggle(t));
      card.append(idx, task, tick); listEl.append(card);
    });
    updateNudge(); updateBar(); updateStreakBadge(); renderTabs();
  }

  function calcProgress(){ const tasks = visibleTasksForChild(R.routines[currentRoutine]); const p=loadProgress(); const doneCount = tasks.filter(t=>p[t.id]).length; return { doneCount, total: tasks.length, allDone: doneCount===tasks.length } }
  function updateBar(){ const {doneCount,total}=calcProgress(); const pct=Math.round((doneCount/Math.max(total,1))*100); barEl.style.width=pct+'%'; progressLabel.textContent=`${pct}% done`; }
  function nextTaskName(){ const tasks=visibleTasksForChild(R.routines[currentRoutine]); const p=loadProgress(); const next=tasks.find(t=>!p[t.id]); return next?next.name:'All done'; }
  function updateNudge(){ const name=nextTaskName(); nudgeEl.innerHTML = name==='All done' ? 'üéâ <strong>All done ‚Äî lovely work!</strong>' : `Next up: <strong>${name}</strong>`; }
  function bumpStreak(){ if(!R.streaksEnabled) return; const s=getStreak(); setStreak(s+1); updateStreakBadge(); }
  function updateStreakBadge(){ if(!streakEl) return; if(!R.streaksEnabled){ streakEl.style.display='none'; return; } const s=getStreak(); streakEl.style.display=''; streakEl.textContent = `üî• ${s}‚Äëday streak`; }\u2011day streak`; }

  function onToggle(task){
    const p=loadProgress();
    const isDone = !!p[task.id];
    // Intercept bedtime tooth brushing to open timer when marking done
    if(currentRoutine==='bed' && task.id==='teeth' && !isDone){ openBrushTimer(task); return; }
    p[task.id] = !isDone; saveProgress(p); render();
    if(R.sync.enabled){ fireAndForget(task, p[task.id] ? 'done' : 'undone'); }
    if(currentRoutine==='morning' && task.id==='get-dressed' && p[task.id]){ showTabletUnlockUntil('07:45'); }
    const {allDone}=calcProgress(); if(allDone){ fireworks(); bumpStreak(); speak(`Brilliant ${currentChild}! All done.`); } else if(p[task.id]){ speak(`Nice one. Next up: ${nextTaskName()}`); }
  }

  el('routineSpeakNext').addEventListener('click', ()=> speak(`Next up: ${nextTaskName()}`));
  el('routineReset').addEventListener('click', ()=>{ if(!confirm("Reset today‚Äôs progress?")) return; saveProgress({}); render(); speak('Starting fresh.'); });

  function speak(text){ if(!R.speakEnabled) return; try{ const u=new SpeechSynthesisUtterance(text); speechSynthesis.cancel(); speechSynthesis.speak(u);}catch{} }

  // Confetti burst
  function fireworks(){ if(!R.confettiEnabled) return; try{ confetti({ particleCount: 120, spread: 70, origin: { y: 0.3 } }); }catch{ /* fallback not needed */ } }

  // Tablet unlock banner until a time
  function showTabletUnlockUntil(timeHHMM){ try{ const now=new Date(); const [hh,mm]=timeHHMM.split(':').map(Number); const limit=new Date(); limit.setHours(hh,mm,0,0); if(now>limit) return; const banner=document.createElement('div'); banner.style.position='fixed'; banner.style.left='50%'; banner.style.top='14px'; banner.style.transform='translateX(-50%)'; banner.style.background='linear-gradient(90deg, #22c55e, #3b82f6)'; banner.style.color='#06121c'; banner.style.padding='12px 16px'; banner.style.borderRadius='12px'; banner.style.fontWeight='900'; banner.style.zIndex='9999'; const span=document.createElement('span'); banner.append('Tablet unlocked until ', span); document.body.append(banner); function tick(){ const left=Math.max(0, limit - new Date()); span.textContent = formatDuration(left); if(left<=0){ banner.remove(); } else { setTimeout(tick, 1000);} } tick(); }catch{} }
  function formatDuration(ms){ const s=Math.floor(ms/1000); const m=Math.floor(s/60); const r=s%60; return `${m}:${String(r).padStart(2,'0')}`; }

  // Fire-and-forget logging
  function fireAndForget(task,status){ try{ if(!R.sync.enabled||!R.sync.endpoint) return; fetch(R.sync.endpoint,{ method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ child: currentChild, routine: currentRoutine, taskId: task.id, status, date: todayKey() })}); }catch{} }

  // Daily roll-over cleanup
  (function roll(){
    const keys=Object.keys(localStorage).filter(k=>k.startsWith('routine:'));
    const today=todayKey();
    keys.forEach(k=>{ const parts=k.split(':'); const storedDate=parts[3]; if(storedDate!==today){ localStorage.removeItem(k); } });
    // Clear manual override at day boundary
    localStorage.removeItem('routine:overrideUntil'); manualOverrideUntil = 0;
  })();

  function svgTick(){ return `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="3" width="18" height="18" rx="5" ry="5" stroke="rgba(0,0,0,.15)" stroke-width="2"/><path d="M7 12.5l3.5 3.5L17 9" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>`; }

  // ----- Brush timer -----
  const modal = document.getElementById('brushTimerModal');
  const dial = document.getElementById('brushDialFill');
  const timeEl = document.getElementById('brushTime');
  const startBtn = document.getElementById('brushStart');
  const pauseBtn = document.getElementById('brushPause');
  const skipBtn = document.getElementById('brushSkip');
  const CIRC = 2*Math.PI*52; // 2œÄr where r=52
  let timerId=null, remain=120, running=false, pendingTask=null;

  function openBrushTimer(task){ if(timerId){ clearInterval(timerId); timerId=null; } pendingTask=task; remain=120; running=false; startBtn.textContent='Start'; pauseBtn.disabled=true; updateDial(); timeEl.textContent='2:00'; modal.style.display='flex'; }
  function closeBrushTimer(){ modal.style.display='none'; }
  function updateDial(){ const frac = 1 - (remain/120); dial.style.strokeDasharray = String(CIRC); dial.style.strokeDashoffset = String(CIRC * (1-frac)); }
  function tick(){ if(!running) return; remain=Math.max(0, remain-1); updateDial(); const m=Math.floor(remain/60), s=String(remain%60).padStart(2,'0'); timeEl.textContent=`${m}:${s}`; if(remain<=0){ finished(); } }
  function finished(){ clearInterval(timerId); timerId=null; running=false; speak('Two minutes done. Sparkly teeth!'); fireworks(); closeBrushTimer(); const p=loadProgress(); if(pendingTask){ p[pendingTask.id]=true; saveProgress(p); if(R.sync.enabled){ fireAndForget(pendingTask,'done'); } } pendingTask=null; render(); const {allDone}=calcProgress(); if(allDone){ bumpStreak(); } } const {allDone}=calcProgress(); if(allDone){ bumpStreak(); }
  }
  startBtn.addEventListener('click', ()=>{ if(running) return; running=true; startBtn.textContent='Resume'; pauseBtn.disabled=false; timerId=setInterval(tick, 1000); speak('Brushing timer started.'); });
  pauseBtn.addEventListener('click', ()=>{ running=false; clearInterval(timerId); pauseBtn.disabled=true; speak('Paused.'); });
  skipBtn.addEventListener('click', ()=>{
    if(timerId){ clearInterval(timerId); timerId=null; }
    running=false;
    if(pendingTask){
      const p=loadProgress(); p[pendingTask.id]=true; saveProgress(p);
      if(R.sync.enabled){ fireAndForget(pendingTask,'done'); }
    }
    pendingTask=null;
    closeBrushTimer();
    render();
    speak('Skipping tonight.');
  });
  modal.addEventListener('click', (e)=>{ if(e.target===modal) closeBrushTimer(); });

  // Boot
  render();
  if (R.auto?.enable) {
    setInterval(()=>{
      if (!shouldAutoSwitch()) return;
      const desired = autoRoutineNow();
      if (desired !== currentRoutine) { currentRoutine = desired; render(); }
    }, 60000);
  }
})();
</script>
</body>
</html>
