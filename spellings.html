<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Spellings Practice</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <script src="config.js"></script>
  <style>
    :root { --bg: linear-gradient(to bottom right, red, orange, yellow, green, blue, indigo, violet); --text:#333; --section-bg:#fff; }
    body.dark { --bg:#111; --text:#f1f1f1; --section-bg:#222; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; background:var(--bg); color:var(--text); }
    header { background:rgba(255,255,255,.85); padding:1rem; text-align:center; font-size:1.5rem; font-weight:800; border-bottom:3px solid #fff; position:relative; z-index:1; }
    .dark header{ background:rgba(0,0,0,.8); border-bottom:3px solid #444; }
    section { background:var(--section-bg); margin:1rem; padding:1rem; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,.08); }
    h2, h3 { margin:.25rem 0 .5rem; }
    .toggle-mode { position:fixed; bottom:1rem; right:1rem; width:50px; height:50px; background:#000; color:#fff; border:0; border-radius:50%; font-size:24px; cursor:pointer; z-index:999; display:flex; align-items:center; justify-content:center; box-shadow:0 2px 5px rgba(0,0,0,.3);} 
    .toggle-mode.sun{ background:#ffd700; color:#333; }

    /* Prevent card contents from overflowing their boxes */
    *, *::before, *::after {
      box-sizing: border-box;
    }

    /* Spellings-specific styles */
    .top-bar { display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:.5rem; margin-bottom:.5rem; }
    .back-link {
      font-size:.9rem; text-decoration:none; padding:.35rem .7rem;
      border-radius:999px; border:1px solid #ddd; background:#fafafa; color:inherit;
    }
    .dark .back-link{ background:#111; border-color:#555; }
    .identity-grid { display:flex; flex-wrap:wrap; gap:1rem; }
    .identity-card, .practice-card {
      flex:1 1 260px;
      background:#f9f9f9;
      border-radius:10px;
      padding:.75rem .9rem;
      border:1px solid #eee;
      min-width:0;
    }
    .dark .identity-card, .dark .practice-card{ background:#111; border-color:#333; }
    label { font-size:.85rem; font-weight:600; display:block; margin-bottom:.2rem; }
    input[type="text"], select {
      width:100%; padding:.45rem .6rem; border-radius:6px; border:1px solid:#ccc; font:inherit;
    }
    .dark input[type="text"], .dark select{ background:#111; border-color:#555; color:inherit; }
    .mode-options { margin-top:.5rem; }
    .mode-options label { font-weight:500; display:flex; align-items:center; gap:.35rem; margin-bottom:.3rem; cursor:pointer; }
    .note { font-size:.8rem; color:#666; margin-top:.35rem; }

    .start-btn {
      margin-top:.7rem;
      padding:.55rem 1rem;
      border-radius:7px;
      border:0;
      background:#81c784;
      color:#fff;
      font:600 1rem system-ui;
      cursor:pointer;
      transition: background .15s ease;
    }
    .start-btn:hover {
      background:#66bb6a;
    }

    .stats-row { display:flex; flex-wrap:wrap; gap:.5rem; margin-bottom:.5rem; }
    .stat-box { flex:1 1 80px; padding:.4rem .5rem; border-radius:7px; background:#f1f5f9; font-size:.8rem; }
    .dark .stat-box{ background:#020617; }
    .stat-label{ color:#666; font-size:.75rem; }
    .stat-main{ font-weight:700; }

    .mode-tabs { display:flex; gap:.4rem; margin-bottom:.5rem; flex-wrap:wrap; }
    .mode-tab{ border-radius:999px; border:1px solid #ddd; padding:.25rem .7rem; font-size:.8rem; background:#f9fafb; cursor:pointer; }
    .mode-tab.active{ background:#fef3c7; border-color:#fbbf24; }
    .mode-tab.disabled{ opacity:.4; cursor:default; }

    .practice-word { font-size:1.6rem; font-weight:800; text-align:center; letter-spacing:.15em; margin:.5rem 0 .6rem; }

    .answer-row{ display:flex; flex-wrap:wrap; gap:.4rem; justify-content:center; margin-bottom:.25rem; }
    .answer-row input[type="text"]{ max-width:220px; }

    .primary-btn{ padding:.45rem .9rem; border-radius:7px; border:0; background:#f97316; color:#fff; font-weight:700; cursor:pointer; }

    .secondary-btn{
      margin:0 auto .4rem auto;
      display:block;
      padding:.3rem .7rem;
      border-radius:7px;
      border:1px solid #d4d4d8;
      background:#e5e7eb;
      font:500 .9rem system-ui;
      cursor:pointer;
    }
    .secondary-btn:hover{
      background:#d4d4d8;
    }

    .feedback{ text-align:center; min-height:1.1rem; font-size:.9rem; }
    .feedback.ok{ color:#16a34a; }
    .feedback.bad{ color:#dc2626; }

    .small-link{ margin-top:.35rem; font-size:.8rem; text-align:right; text-decoration:underline; cursor:pointer; }
  </style>
</head>
<body>
  <header>‚úèÔ∏è Spellings Practice</header>
  <button class="toggle-mode" id="modeToggle">üåô</button>

  <section id="mainSection">
    <div class="top-bar">
      <div id="modeLabel"><strong>Spellings practice</strong> ‚Äì choose your name and year.</div>
      <a href="index.html?home=benton" class="back-link" id="backLink">‚¨Ö Back to Dashboard</a>
    </div>
    <p id="subtitle">Type your name and choose your year or phase to start.</p>

    <div class="identity-grid" id="identityStep">
      <div class="identity-card">
        <h3>Who‚Äôs practising?</h3>
        <label for="learnerNameInput">Name</label>
        <input id="learnerNameInput" type="text" placeholder="e.g. Jessica F" autocomplete="off" />
        <label for="phaseSelect">Year / Phase</label>
        <select id="phaseSelect">
          <option value="">Select‚Ä¶</option>
          <option value="eyfs">EYFS</option>
          <option value="y3">Year 3</option>
        </select>

        <p class="note">Your score and streak are for this session only.</p>
      </div>

      <div class="identity-card">
        <h3>What are you practising?</h3>
        <div class="mode-options">
          <label><input type="radio" name="contentMode" value="robin" checked> Weekly spellings (Year 3)</label>
          <label><input type="radio" name="contentMode" value="eyfs"> EYFS sound blending</label>
        </div>

        <div id="eyfsSetRow" style="margin-top:.5rem; display:none;">
          <label for="eyfsSetSelect">EYFS set</label>
          <select id="eyfsSetSelect"></select>
        </div>

        <button class="start-btn" id="startPracticeBtn">Start practising ‚ñ∂Ô∏è</button>
      </div>
    </div>

    <div id="practiceStep" style="display:none;">
      <div class="practice-card">
        <h3 id="activeLearnerTitle">Practising</h3>
        <p style="font-size:.85rem; color:#666;" id="listLabel"></p>

        <div class="stats-row">
          <div class="stat-box">
            <div class="stat-label">Level</div>
            <div class="stat-main" id="statLevel">1</div>
            <div class="stat-label" id="statXP">0 XP</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Streak</div>
            <div class="stat-main" id="statStreak">0</div>
            <div class="stat-label">Best <span id="statBestStreak">0</span></div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Total</div>
            <div class="stat-main"><span id="statCorrect">0</span> / <span id="statTotal">0</span></div>
          </div>
        </div>

        <div class="mode-tabs">
          <button class="mode-tab active" data-level="1">Level 1 ‚Äì straight spell it</button>
          <button class="mode-tab" data-level="2">Level 2 ‚Äì missing letters</button>
          <button class="mode-tab" data-level="3">Level 3 ‚Äì clue & audio</button>
        </div>

        <div class="practice-word" id="currentWord">start</div>

        <button class="secondary-btn" id="speakButton" style="display:none;">üîä Hear the word</button>

        <div class="answer-row">
          <input id="answerInput" type="text" placeholder="Type the word here‚Ä¶" autocomplete="off" />
          <button class="primary-btn" id="checkButton"><span id="checkButtonLabel">Check</span></button>
        </div>

        <div class="feedback" id="feedback"></div>
        <div class="small-link" id="changeLearnerLink">Change learner / list</div>
      </div>
    </div>
  </section>

<script>
/* ========== Theme ========== */
const modeBtn = document.getElementById('modeToggle');
function setInitialTheme(){
  const stored = localStorage.getItem('theme');
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  const dark = stored ? stored === 'dark' : prefersDark;
  document.body.classList.toggle('dark', dark);
  modeBtn.textContent = dark ? '‚òÄÔ∏è' : 'üåô';
  modeBtn.classList.toggle('sun', dark);
}
modeBtn.onclick = () => {
  const dark = !document.body.classList.contains('dark');
  document.body.classList.toggle('dark', dark);
  localStorage.setItem('theme', dark ? 'dark' : 'light');
  modeBtn.textContent = dark ? '‚òÄÔ∏è' : 'üåô';
  modeBtn.classList.toggle('sun', dark);
};

/* ========== Content sources ========== */
/* Fallback list only. Real data comes from Sheet. */
const CURRENT_WEEK_SPELLINGS = ["placeholder"];

const EYFS_SETS = {
  set1: { label: "Phase 2 ‚Äì Set 1 (s a t p)", words: ["sat","tap","pat","sap","at","as"] },
  set2: { label: "Phase 2 ‚Äì Set 2 (i n m d)", words: ["din","dim","pin","nip","mad","sad"] },
  set3: { label: "Phase 2 ‚Äì Set 3 (g o c k)", words: ["dog","cog","cop","cot","kit","kick"] },
  set4: { label: "Phase 2 ‚Äì Set 4 (ck e u r)", words: ["duck","back","tuck","ruck","red","bed"] }
};

let robinWordsRemote = [];

async function loadRobinWordsFromSheet() {
  try {
    if (!window.config || !window.config.spellingsUrl) return;
    const url = window.config.spellingsUrl + '?t=' + Date.now();
    const resp = await fetch(url, { cache:'no-store' });
    const data = await resp.json();
    if (Array.isArray(data.robinCurrent)) {
      robinWordsRemote = data.robinCurrent;
    }
  } catch {}
}

/* ========== State ========== */
const learnerNameInput = document.getElementById("learnerNameInput");
const phaseSelect = document.getElementById("phaseSelect");
const modeLabel = document.getElementById("modeLabel");
const subtitle = document.getElementById("subtitle");
const identityStep = document.getElementById("identityStep");
const practiceStep = document.getElementById("practiceStep");

/* ========== Back Button Visibility ========== */
const params = new URLSearchParams(window.location.search);
const isHomeMode = params.get('home') === 'benton';
const backLink = document.getElementById("backLink");
if (!isHomeMode && backLink) backLink.style.display = "none";

const startPracticeBtn = document.getElementById("startPracticeBtn");
const eyfsSetRow = document.getElementById("eyfsSetRow");
const eyfsSetSelect = document.getElementById("eyfsSetSelect");

const activeLearnerTitle = document.getElementById("activeLearnerTitle");
const listLabel = document.getElementById("listLabel");
const statLevel = document.getElementById("statLevel");
const statXP = document.getElementById("statXP");
const statStreak = document.getElementById("statStreak");
const statBestStreak = document.getElementById("statBestStreak");
const statCorrect = document.getElementById("statCorrect");
const statTotal = document.getElementById("statTotal");

const modeTabs = document.querySelectorAll(".mode-tab");
const currentWordEl = document.getElementById("currentWord");
const speakButton = document.getElementById("speakButton");
const answerInput = document.getElementById("answerInput");
const checkButton = document.getElementById("checkButton");
const checkButtonLabel = document.getElementById("checkButtonLabel");
const feedbackEl = document.getElementById("feedback");
const changeLearnerLink = document.getElementById("changeLearnerLink");

let currentLearner = null;
let currentPhase = "";
let currentContentMode = "robin";

let currentLevel = 1;
let currentMode = 1;        // GAME MODE: 1 = full word, 2 = missing letters, 3 = clue & audio
let awaitingNextWord = false;

let wordQueue = [];
let currentTargetWord = "";

// Session-only stats
let sessionTotal = 0;
let sessionCorrect = 0;
let sessionStreak = 0;
let bestSessionStreak = 0;
let sessionXP = 0;

/* ========== Helpers ========== */
function shuffleArray(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function rebuildWordQueue() {
  const list = getWordList();
  if (!list.length) { wordQueue = []; return; }
  wordQueue = shuffleArray(list.slice());
}

function maskWordForLevel2(word) {
  const chars = word.split('');
  if (chars.length <= 2) {
    if (chars.length === 2) chars[1] = '_';
    return chars.join('');
  }
  const interior = [];
  for (let i = 1; i < chars.length - 1; i++) interior.push(i);
  let toHide = 1;
  if (chars.length >= 4 && chars.length <= 6) toHide = 2;
  if (chars.length >= 7) toHide = 3;
  if (toHide > interior.length) toHide = interior.length;
  for (let i = interior.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [interior[i], interior[j]] = [interior[j], interior[i]];
  }
  for (let k = 0; k < toHide; k++) chars[interior[k]] = '_';
  return chars.join('');
}

function buildClueForLevel3(word) {
  if (!word) return "";
  const clean = String(word).trim();
  if (!clean.length) return "";
  const first = clean[0].toLowerCase();
  const len = clean.length;
  return `Starts with "${first}" ‚Ä¢ ${len} letters`;
}

function toggleSpeakButton() {
  if (!speakButton) return;
  const canSpeak = typeof window !== "undefined" && "speechSynthesis" in window;
  if (currentMode === 3 && currentTargetWord && canSpeak) {
    speakButton.style.display = "block";
  } else {
    speakButton.style.display = "none";
  }
}

function speakCurrentWord() {
  if (!("speechSynthesis" in window)) return;
  if (!currentTargetWord) return;
  const utter = new SpeechSynthesisUtterance(currentTargetWord);
  utter.lang = "en-GB";
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(utter);
}

function getRadioValue(name){
  const els = document.querySelectorAll(`input[name="${name}"]`);
  for (const el of els) if (el.checked) return el.value;
  return null;
}

function refreshStatsUI() {
  const level = Math.min(5, 1 + Math.floor(sessionXP / 50));
  currentLevel = level;
  statLevel.textContent = level;
  statXP.textContent = `${sessionXP} XP`;
  statStreak.textContent = sessionStreak;
  statBestStreak.textContent = bestSessionStreak;
  statCorrect.textContent = sessionCorrect;
  statTotal.textContent = sessionTotal;
}

function getWordList() {
  if (currentContentMode === "robin") {
    const fromSheet = robinWordsRemote.length ? robinWordsRemote : null;
    const source = fromSheet || CURRENT_WEEK_SPELLINGS;
    return source.slice();
  } else {
    const key = eyfsSetSelect.value;
    const set = EYFS_SETS[key];
    return set ? set.words.slice() : [];
  }
}

function pickNextWord() {
  if (!wordQueue.length) rebuildWordQueue();
  if (!wordQueue.length) {
    currentWordEl.textContent = "No words.";
    currentTargetWord = "";
    toggleSpeakButton();
    return;
  }

  const next = wordQueue.shift();
  currentTargetWord = next;

  let toShow = next;
  if (currentMode === 2) {
    toShow = maskWordForLevel2(next);
  } else if (currentMode === 3) {
    toShow = buildClueForLevel3(next);
  }

  currentWordEl.textContent = toShow;
  answerInput.value = "";
  answerInput.focus();
  feedbackEl.textContent = "";
  awaitingNextWord = false;
  checkButtonLabel.textContent = "Check";
  toggleSpeakButton();
}

function handleAnswer() {
  if (!currentLearner) return;

  if (awaitingNextWord){ pickNextWord(); return; }

  const target = currentTargetWord.trim().toLowerCase();
  const guess = answerInput.value.trim().toLowerCase();

  if (!target || !guess){
    feedbackEl.textContent = "Type the word first.";
    feedbackEl.className = "feedback bad";
    return;
  }

  sessionTotal++;

  if (guess === target){
    sessionCorrect++;
    sessionStreak++;
    bestSessionStreak = Math.max(bestSessionStreak, sessionStreak);
    sessionXP += 10;

    feedbackEl.textContent = "Nice, that‚Äôs correct! üéâ";
    feedbackEl.className = "feedback ok";
  } else {
    feedbackEl.textContent = `Close ‚Äì the correct spelling is ‚Äú${target}‚Äù.`;
    feedbackEl.className = "feedback bad";
    sessionStreak = 0;
  }

  refreshStatsUI();
  awaitingNextWord = true;
  checkButtonLabel.textContent = "Next word";
}

/* ========== UI ========== */
function initEYFSSelect(){
  eyfsSetSelect.innerHTML = "";
  Object.entries(EYFS_SETS).forEach(([key,val])=>{
    const opt = document.createElement("option");
    opt.value = key;
    opt.textContent = val.label;
    eyfsSetSelect.appendChild(opt);
  });
}

document.querySelectorAll('input[name="contentMode"]').forEach(radio=>{
  radio.addEventListener("change",()=>{
    currentContentMode = getRadioValue("contentMode") || "robin";
    eyfsSetRow.style.display = currentContentMode === "eyfs" ? "block" : "none";
  });
});

modeTabs.forEach(tab=>{
  tab.addEventListener("click",()=>{
    if (tab.classList.contains("disabled")) return;
    const mode = Number(tab.dataset.level);
    currentMode = mode;

    modeTabs.forEach(t=> t.classList.toggle("active", t===tab));

    if (currentTargetWord){
      let disp = currentTargetWord;
      if (currentMode === 2) {
        disp = maskWordForLevel2(currentTargetWord);
      } else if (currentMode === 3) {
        disp = buildClueForLevel3(currentTargetWord);
      }
      currentWordEl.textContent = disp;
      feedbackEl.textContent = "";
      awaitingNextWord = false;
      checkButtonLabel.textContent = "Check";
      toggleSpeakButton();
    } else {
      if (practiceStep.style.display === "block") pickNextWord();
    }
  });
});

startPracticeBtn.addEventListener("click",()=>{
  const name = learnerNameInput.value.trim();
  const phase = phaseSelect.value;
  if (!name){ alert("Enter a name."); return; }
  if (!phase){ alert("Choose a year/phase."); return; }

  currentLearner = name;
  currentPhase = phase;
  currentContentMode = getRadioValue("contentMode") || "robin";

  sessionTotal = sessionCorrect = sessionStreak = bestSessionStreak = sessionXP = 0;
  refreshStatsUI();

  identityStep.style.display = "none";
  practiceStep.style.display = "block";
  activeLearnerTitle.textContent = `Practising: ${name}`;

  if (currentContentMode === "robin"){
    listLabel.textContent = "Using this week‚Äôs spellings list.";
  } else {
    const set = EYFS_SETS[eyfsSetSelect.value];
    listLabel.textContent = set ? set.label : "EYFS blending set.";
  }

  rebuildWordQueue();
  pickNextWord();
});

eyfsSetSelect.addEventListener("change",()=>{
  if (practiceStep.style.display === "block" && currentContentMode==="eyfs"){
    const set = EYFS_SETS[eyfsSetSelect.value];
    listLabel.textContent = set ? set.label : "EYFS set.";
    rebuildWordQueue();
    pickNextWord();
  }
});

checkButton.addEventListener("click", handleAnswer);
answerInput.addEventListener("keydown", e=>{
  if (e.key==="Enter"){
    e.preventDefault();
    handleAnswer();
  }
});

changeLearnerLink.addEventListener("click",()=>{
  practiceStep.style.display="none";
  identityStep.style.display="flex";
  subtitle.textContent = "Type your name and choose your year or phase to start.";
});

if (speakButton) {
  speakButton.addEventListener("click", speakCurrentWord);
}

/* ========== Boot ========== */
window.addEventListener('load',()=>{
  setInitialTheme();
  initEYFSSelect();
  loadRobinWordsFromSheet();
});
</script>
</body>
</html>
