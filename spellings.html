<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Spellings Practice</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <script src="config.js"></script>
  <!-- Confetti for celebrations -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <style>
    :root { --bg: linear-gradient(to bottom right, red, orange, yellow, green, blue, indigo, violet); --text:#333; --section-bg:#fff; }
    body.dark { --bg:#111; --text:#f1f1f1; --section-bg:#222; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; background:var(--bg); color:var(--text); }
    header { background:rgba(255,255,255,.85); padding:1rem; text-align:center; font-size:1.5rem; font-weight:800; border-bottom:3px solid #fff; position:relative; z-index:1; }
    .dark header{ background:rgba(0,0,0,.8); border-bottom:3px solid #444; }
    section { background:var(--section-bg); margin:1rem; padding:1rem; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,.08); }
    h2, h3 { margin:.25rem 0 .5rem; }
    .toggle-mode { position:fixed; bottom:1rem; right:1rem; width:50px; height:50px; background:#000; color:#fff; border:0; border-radius:50%; font-size:24px; cursor:pointer; z-index:999; display:flex; align-items:center; justify-content:center; box-shadow:0 2px 5px rgba(0,0,0,.3);} 
    .toggle-mode.sun{ background:#ffd700; color:#333; }

    /* Prevent card contents from overflowing their boxes */
    *, *::before, *::after {
      box-sizing: border-box;
    }

    /* Spellings-specific styles */
    .top-bar { display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:.5rem; margin-bottom:.5rem; }
    .back-link {
      font-size:.9rem; text-decoration:none; padding:.35rem .7rem;
      border-radius:999px; border:1px solid #ddd; background:#fafafa; color:inherit;
    }
    .dark .back-link{ background:#111; border-color:#555; }
    .identity-grid { display:flex; flex-wrap:wrap; gap:1rem; }
    .identity-card, .practice-card {
      flex:1 1 260px;
      background:#f9f9f9;
      border-radius:10px;
      padding:.75rem .9rem;
      border:1px solid #eee;
      min-width:0;
    }
    .dark .identity-card, .dark .practice-card{ background:#111; border-color:#333; }
    label { font-size:.85rem; font-weight:600; display:block; margin-bottom:.2rem; }
    input[type="text"], select {
      width:100%; padding:.45rem .6rem; border-radius:6px; border:1px solid #ccc; font:inherit;
    }
    .dark input[type="text"], .dark select{ background:#111; border-color:#555; color:inherit; }
    .mode-options { margin-top:.5rem; }
    .mode-options label { font-weight:500; display:flex; align-items:center; gap:.35rem; margin-bottom:.3rem; cursor:pointer; }
    .note { font-size:.8rem; color:#666; margin-top:.35rem; }

    .start-btn {
      margin-top:.7rem;
      padding:.55rem 1rem;
      border-radius:7px;
      border:0;
      background:#81c784;
      color:#fff;
      font:600 1rem system-ui;
      cursor:pointer;
      transition: background .15s ease;
    }
    .start-btn:hover {
      background:#66bb6a;
    }

    .stats-row { display:flex; flex-wrap:wrap; gap:.5rem; margin-bottom:.5rem; }
    .stat-box { flex:1 1 80px; padding:.4rem .5rem; border-radius:7px; background:#f1f5f9; font-size:.8rem; }
    .dark .stat-box{ background:#020617; }
    .stat-label{ color:#666; font-size:.75rem; }
    .stat-main{ font-weight:700; }

    .mode-tabs { display:flex; gap:.4rem; margin-bottom:.5rem; flex-wrap:wrap; }
    .mode-tab{ border-radius:999px; border:1px solid #ddd; padding:.25rem .7rem; font-size:.8rem; background:#f9fafb; cursor:pointer; }
    .mode-tab.active{ background:#fef3c7; border-color:#fbbf24; }
    .mode-tab.disabled{ opacity:.4; cursor:default; }

    .practice-word { font-size:1.6rem; font-weight:800; text-align:center; letter-spacing:.15em; margin:.5rem 0 .6rem; }

    .answer-row{ display:flex; flex-wrap:wrap; gap:.4rem; justify-content:center; margin-bottom:.25rem; }
    .answer-row input[type="text"]{ max-width:220px; }

    .primary-btn{ padding:.45rem .9rem; border-radius:7px; border:0; background:#f97316; color:#fff; font-weight:700; cursor:pointer; }

    .secondary-btn{
      margin:0 auto .4rem auto;
      display:block;
      padding:.3rem .7rem;
      border-radius:7px;
      border:1px solid #d4d4d8;
      background:#e5e7eb;
      font:500 .9rem system-ui;
      cursor:pointer;
    }
    .secondary-btn:hover{
      background:#d4d4d8;
    }
        /* Locked state for wordsearch button */
    #generateWordsearchBtn[disabled] {
      opacity: .5;
      cursor: not-allowed;
    }

    .feedback{ text-align:center; min-height:1.1rem; font-size:.9rem; }
    .feedback.ok{ color:#16a34a; }
    .feedback.bad{ color:#dc2626; }

    .small-link{ margin-top:.35rem; font-size:.8rem; text-align:right; text-decoration:underline; cursor:pointer; }

    /* Word search styles */
    #wordsearchStep { margin-top:1rem; }
    .wordsearch-grid { margin-top:.5rem; display:inline-block; border:1px solid #ddd; }
    .wordsearch-grid table { border-collapse:collapse; }
    .wordsearch-grid td {
      width:24px;
      height:24px;
      text-align:center;
      font-weight:600;
      border:1px solid #ddd;
      font-size:.9rem;
      user-select:none;
    }
    .dark .wordsearch-grid td { border-color:#555; }
    .wordsearch-grid td.ws-selected {
      outline:2px solid #f97316;
      outline-offset:-2px;
    }
    .wordsearch-words {
      margin-top:.5rem;
      font-size:.85rem;
    }
    .wordsearch-words .ws-word {
      display:inline-block;
      margin-right:.35rem;
      margin-bottom:.2rem;
      padding:.1rem .35rem;
      border-radius:6px;
      cursor:default;
    }
    .wordsearch-words .ws-word.found {
      background:#bbf7d0;
      text-decoration:line-through;
    }
    .dark .wordsearch-words .ws-word.found {
      background:#166534;
      color:#fff;
    }
  </style>
</head>
<body>
  <header>‚úèÔ∏è Spellings Practice</header>
  <button class="toggle-mode" id="modeToggle">üåô</button>

  <section id="mainSection">
    <div class="top-bar">
      <div id="modeLabel"><strong>Spellings practice</strong></div>
      <a href="index.html?home=benton" class="back-link" id="backLink">‚¨Ö Back to Dashboard</a>
    </div>
    <p id="subtitle">Who‚Äôs practising? Enter your name and year to begin.</p>

    <div class="identity-grid" id="identityStep">
      <div class="identity-card">
        <h3>Who‚Äôs practising?</h3>
        <label for="learnerNameInput">Name</label>
        <input id="learnerNameInput" type="text" placeholder="e.g. Jessica F" autocomplete="off" />
        <label for="phaseSelect">Year / Phase</label>
        <select id="phaseSelect">
          <option value="">Select‚Ä¶</option>
          <option value="eyfs">EYFS</option>
          <option value="y3">Year 3</option>
        </select>

        <p class="note">Your score and streak are for this session only.</p>
      </div>

      <div class="identity-card">
        <h3>What are you practising?</h3>
        <div class="mode-options">
        <label id="robinModeOption">
          <input type="radio" name="contentMode" value="robin" checked> Weekly spellings (Year 3)
        </label>
        <label id="eyfsModeOption">
          <input type="radio" name="contentMode" value="eyfs"> EYFS sound blending
        </label>
        <label id="numbersModeOption" style="display:none;">
          <input type="radio" name="contentMode" value="numbers"> Numbers practice (Year 3)
        </label>
      </div>

        <div id="eyfsSetRow" style="margin-top:.5rem; display:none;">
          <label for="eyfsSetSelect">EYFS set</label>
          <select id="eyfsSetSelect"></select>
        </div>

        <button class="start-btn" id="startPracticeBtn">Start practising ‚ñ∂Ô∏è</button>
      </div>
    </div>

    <div id="practiceStep" style="display:none;">
      <!-- Spellings practice card (unchanged) -->
      <div class="practice-card" id="spellingsCard">
        <h3 id="activeLearnerTitle">Practising</h3>
        <p style="font-size:.85rem; color:#666;" id="listLabel"></p>
    
        <div class="stats-row">
          <div class="stat-box">
            <div class="stat-label">Level</div>
            <div class="stat-main" id="statLevel">1</div>
            <div class="stat-label" id="statXP">0 XP</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Streak</div>
            <div class="stat-main" id="statStreak">0</div>
            <div class="stat-label">Best <span id="statBestStreak">0</span></div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Total</div>
            <div class="stat-main"><span id="statCorrect">0</span> / <span id="statTotal">0</span></div>
          </div>
        </div>
    
        <div class="mode-tabs">
          <button class="mode-tab active" data-level="1">Level 1 ‚Äì straight spell it</button>
          <button class="mode-tab disabled" data-level="2">Level 2 ‚Äì missing letters</button>
          <button class="mode-tab disabled" data-level="3">Level 3 ‚Äì clue & audio</button>
        </div>
    
        <div class="practice-word" id="currentWord">start</div>
    
        <button class="secondary-btn" id="speakButton" style="display:none;">üîä Hear the word</button>
        <button class="secondary-btn" id="extraClueButton" style="display:none;">üí° Show letter pattern</button>
    
        <div class="answer-row">
          <input id="answerInput" type="text" placeholder="Type the word here‚Ä¶" autocomplete="off" />
          <button class="primary-btn" id="checkButton"><span id="checkButtonLabel">Check</span></button>
        </div>
    
        <div class="feedback" id="feedback"></div>
        <div class="small-link" id="changeLearnerLink">Change learner / list</div>
      </div>
    
      <!-- Numbers practice card (new) -->
      <div class="practice-card" id="numbersCard" style="display:none;">
        <h3 id="numbersTitle">Numbers practice</h3>
        <p style="font-size:.85rem; color:#666;" id="numbersListLabel">
          Using this week‚Äôs numbers.
        </p>
        <!-- New progress line -->
        <p style="font-size:.8rem; color:#666;" id="numbersProgressText"></p>
        
        <div class="practice-word" id="currentQuestion">12 √ó 3</div>
    
        <div class="answer-row">
          <input id="numbersAnswerInput" type="text" placeholder="Type the answer‚Ä¶" autocomplete="off" />
          <button class="primary-btn" id="numbersCheckButton"><span id="numbersCheckButtonLabel">Check</span></button>
        </div>
    
        <div class="feedback" id="numbersFeedback"></div>
        <div class="small-link" id="numbersChangeLearnerLink">Change learner / activity</div>
      </div>
    </div>

    <div id="wordsearchStep" style="display:none;">
      <div class="practice-card">
        <h3>Word Search</h3>
        <p style="font-size:.85rem; color:#666;" id="wordsearchStatusText">Locked. Finish all 3 levels to unlock the word search.</p>
        <button class="primary-btn" id="generateWordsearchBtn">Generate word search</button>
        <div id="wordsearchGrid" class="wordsearch-grid"></div>
        <p id="wordsearchWords" class="wordsearch-words"></p>
      </div>
    </div>
  </section>

<script>
/* ========== Theme ========== */
const modeBtn = document.getElementById('modeToggle');
function setInitialTheme(){
  const stored = localStorage.getItem('theme');
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  const dark = stored ? stored === 'dark' : prefersDark;
  document.body.classList.toggle('dark', dark);
  modeBtn.textContent = dark ? '‚òÄÔ∏è' : 'üåô';
  modeBtn.classList.toggle('sun', dark);
}
modeBtn.onclick = () => {
  const dark = !document.body.classList.contains('dark');
  document.body.classList.toggle('dark', dark);
  localStorage.setItem('theme', dark ? 'dark' : 'light');
  modeBtn.textContent = dark ? '‚òÄÔ∏è' : 'üåô';
  modeBtn.classList.toggle('sun', dark);
};

/* ========== Content sources ========== */
/* Fallback list only. Real data comes from Sheet. */
const CURRENT_WEEK_SPELLINGS = ["placeholder"];

const EYFS_SETS = {
  set1: { label: "Phase 2 ‚Äì Set 1 (s a t p)", words: ["sat","tap","pat","sap","at","as"] },
  set2: { label: "Phase 2 ‚Äì Set 2 (i n m d)", words: ["din","dim","pin","nip","mad","sad"] },
  set3: { label: "Phase 2 ‚Äì Set 3 (g o c k)", words: ["dog","cog","cop","cot","kit","kick"] },
  set4: { label: "Phase 2 ‚Äì Set 4 (ck e u r)", words: ["duck","back","tuck","ruck","red","bed"] }
};

let robinWordsRemote = [];

async function loadRobinWordsFromSheet() {
  try {
    if (!window.config || !window.config.spellingsUrl) return;
    const url = window.config.spellingsUrl + '?t=' + Date.now();
    const resp = await fetch(url, { cache:'no-store' });
    const data = await resp.json();
    if (Array.isArray(data.robinCurrent)) {
      robinWordsRemote = data.robinCurrent;
    }
  } catch (err) {
    console.error('Error loading spellings from Sheet', err);
  }
}

/* ========== State / DOM ========== */
const learnerNameInput = document.getElementById("learnerNameInput");
const phaseSelect = document.getElementById("phaseSelect");
const modeLabel = document.getElementById("modeLabel");
const subtitle = document.getElementById("subtitle");
const identityStep = document.getElementById("identityStep");
const practiceStep = document.getElementById("practiceStep");
const wordsearchStep = document.getElementById("wordsearchStep");

/* Back button visibility */
const params = new URLSearchParams(window.location.search);
const isHomeMode = params.get('home') === 'benton';
const backLink = document.getElementById("backLink");
if (!isHomeMode && backLink) backLink.style.display = "none";

const startPracticeBtn = document.getElementById("startPracticeBtn");
const eyfsSetRow = document.getElementById("eyfsSetRow");
const eyfsSetSelect = document.getElementById("eyfsSetSelect");

const activeLearnerTitle = document.getElementById("activeLearnerTitle");
const listLabel = document.getElementById("listLabel");
const statLevel = document.getElementById("statLevel");
const statXP = document.getElementById("statXP");
const statStreak = document.getElementById("statStreak");
const statBestStreak = document.getElementById("statBestStreak");
const statCorrect = document.getElementById("statCorrect");
const statTotal = document.getElementById("statTotal");

const modeTabs = document.querySelectorAll(".mode-tab");
const currentWordEl = document.getElementById("currentWord");
const speakButton = document.getElementById("speakButton");
const extraClueButton = document.getElementById("extraClueButton");
const answerInput = document.getElementById("answerInput");
const checkButton = document.getElementById("checkButton");
const checkButtonLabel = document.getElementById("checkButtonLabel");
const feedbackEl = document.getElementById("feedback");
const changeLearnerLink = document.getElementById("changeLearnerLink");

const generateWordsearchBtn = document.getElementById("generateWordsearchBtn");
const wordsearchGridEl = document.getElementById("wordsearchGrid");
const wordsearchWordsEl = document.getElementById("wordsearchWords");
const wordsearchStatusText = document.getElementById("wordsearchStatusText");

/* Numbers DOM (will be null if you haven't added the numbers card yet) */
const spellingsCard = document.getElementById("spellingsCard");
const numbersCard = document.getElementById("numbersCard");

const robinModeOption  = document.getElementById("robinModeOption");
const eyfsModeOption   = document.getElementById("eyfsModeOption");
const numbersModeOption = document.getElementById("numbersModeOption");

const numbersTitle = document.getElementById("numbersTitle");
const numbersListLabel = document.getElementById("numbersListLabel");
const numbersProgressText = document.getElementById("numbersProgressText");
const currentQuestionEl = document.getElementById("currentQuestion");
const numbersAnswerInput = document.getElementById("numbersAnswerInput");
const numbersCheckButton = document.getElementById("numbersCheckButton");
const numbersCheckButtonLabel = document.getElementById("numbersCheckButtonLabel");
const numbersFeedback = document.getElementById("numbersFeedback");
const numbersChangeLearnerLink = document.getElementById("numbersChangeLearnerLink");

/* Core state */
let currentLearner = null;
let currentPhase = "";
let currentContentMode = "robin";   // 'robin' | 'eyfs' | 'numbers'

let currentLevel = 1;
let currentMode = 1;        // 1 = full word, 2 = missing letters, 3 = clue & audio
let awaitingNextWord = false;

let wordQueue = [];
let currentTargetWord = "";

// Session-only stats
let sessionTotal = 0;
let sessionCorrect = 0;
let sessionStreak = 0;
let bestSessionStreak = 0;
let sessionXP = 0;

// Level progression: one cycle of up to 6 words per level (spellings only)
const LEVEL_TARGET_MAX = 6;
let levelCompletion = {
  1: false,
  2: false,
  3: false
};
let levelWordSets = {
  1: new Set(),
  2: new Set(),
  3: new Set()
};

/* Wordsearch state */
let wordsearchCurrentWords = [];
let wordsearchFound = new Set();
const wordsearchColours = [
  "#fee2e2","#dbeafe","#dcfce7","#fef9c3","#ede9fe",
  "#cffafe","#ffedd5","#f5d0fe","#bbf7d0","#fecaca"
];
let selecting = false;
let dragStartRow = null;
let dragStartCol = null;
let selectionCells = [];

/* Numbers practice state */
let numbersQuestions = [];
let numbersIndex = 0;
let numbersAwaitingNext = false;

/* ========== Helpers ========== */
function shuffleArray(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function rebuildWordQueue() {
  const list = getWordList();
  if (!list.length) { wordQueue = []; return; }
  wordQueue = shuffleArray(list.slice());
}

function maskWordForLevel2(word) {
  const chars = word.split('');
  if (chars.length <= 2) {
    if (chars.length === 2) chars[1] = '_';
    return chars.join('');
  }
  const interior = [];
  for (let i = 1; i < chars.length - 1; i++) interior.push(i);
  let toHide = 1;
  if (chars.length >= 4 && chars.length <= 6) toHide = 2;
  if (chars.length >= 7) toHide = 3;
  if (toHide > interior.length) toHide = interior.length;
  for (let i = interior.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [interior[i], interior[j]] = [interior[j], interior[i]];
  }
  for (let k = 0; k < toHide; k++) chars[interior[k]] = '_';
  return chars.join('');
}

function buildClueForLevel3(word) {
  if (!word) return "";
  const clean = String(word).trim();
  if (!clean.length) return "";
  const first = clean[0].toLowerCase();
  const len = clean.length;
  return `Starts with "${first}" ‚Ä¢ ${len} letters`;
}

function buildPatternForLevel3(word) {
  if (!word) return "";
  const clean = String(word).trim();
  if (!clean.length) return "";
  if (clean.length <= 2) return clean;
  const first = clean[0];
  const last = clean[clean.length - 1];
  const middle = Array(clean.length - 2).fill('_').join(' ');
  return `${first} ${middle} ${last}`;
}

function toggleSpeakButton() {
  const canSpeak = typeof window !== "undefined" && "speechSynthesis" in window;

  if (speakButton) {
    if (currentMode === 3 && currentTargetWord && canSpeak) {
      speakButton.style.display = "block";
    } else {
      speakButton.style.display = "none";
    }
  }

  if (extraClueButton) {
    if (currentMode === 3 && currentTargetWord) {
      extraClueButton.style.display = "block";
    } else {
      extraClueButton.style.display = "none";
    }
  }
}

function speakCurrentWord() {
  if (!("speechSynthesis" in window)) return;
  if (!currentTargetWord) return;
  const utter = new SpeechSynthesisUtterance(currentTargetWord);
  utter.lang = "en-GB";
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(utter);
}

function getRadioValue(name){
  const els = document.querySelectorAll(`input[name="${name}"]`);
  for (const el of els) if (el.checked) return el.value;
  return null;
}

function refreshStatsUI() {
  const level = Math.min(5, 1 + Math.floor(sessionXP / 50));
  currentLevel = level;
  statLevel.textContent = level;
  statXP.textContent = `${sessionXP} XP`;
  statStreak.textContent = sessionStreak;
  statBestStreak.textContent = bestSessionStreak;
  statCorrect.textContent = sessionCorrect;
  statTotal.textContent = sessionTotal;
}

/* Level / wordsearch helpers */
function getBaseTargetWords() {
  const list = getWordList()
    .map(w => String(w || "").trim().toLowerCase())
    .filter(Boolean);
  const unique = Array.from(new Set(list));
  return unique.slice(0, LEVEL_TARGET_MAX);
}

function updateLevelTabsUI() {
  const done1 = levelCompletion[1];
  const done2 = levelCompletion[2];

  modeTabs.forEach(tab => {
    const lvl = Number(tab.dataset.level);
    if (lvl === 1) {
      tab.classList.remove('disabled');
    } else if (lvl === 2) {
      tab.classList.toggle('disabled', !done1);
    } else if (lvl === 3) {
      tab.classList.toggle('disabled', !done2);
    }
  });
}

function updateWordsearchLockUI() {
  if (!generateWordsearchBtn) return;
  const allDone = levelCompletion[1] && levelCompletion[2] && levelCompletion[3];

  if (allDone) {
    generateWordsearchBtn.disabled = false;
    generateWordsearchBtn.textContent = "Generate word search";
    if (wordsearchStatusText) {
      wordsearchStatusText.textContent = "Unlocked! You completed all 3 levels. Enjoy the word search.";
    }
  } else {
    generateWordsearchBtn.disabled = true;
    generateWordsearchBtn.textContent = "Locked ‚Äì finish all 3 levels first";
    if (wordsearchStatusText) {
      wordsearchStatusText.textContent = "Locked. Complete one cycle of up to 6 words in Levels 1, 2 and 3 to unlock.";
    }
  }
}

function registerCorrectAnswerForCurrentLevel(word) {
  // Numbers mode does NOT affect level / wordsearch unlock
  if (currentContentMode === "numbers") return;
  if (!word) return;

  const lvl = currentMode; // 1,2,3
  if (lvl < 1 || lvl > 3) return;

  const baseTargets = getBaseTargetWords();
  if (!baseTargets.length) return;

  const lower = word.trim().toLowerCase();
  if (!baseTargets.includes(lower)) return;

  const set = levelWordSets[lvl];
  set.add(lower);

  const targetCount = Math.min(LEVEL_TARGET_MAX, baseTargets.length);
  if (!levelCompletion[lvl] && set.size >= targetCount) {
    levelCompletion[lvl] = true;

    if (typeof confetti === "function") {
      confetti({
        particleCount: 120,
        spread: 70,
        origin: { y: 0.7 }
      });
    }

    feedbackEl.textContent = `Level ${lvl} complete ‚Äì nice work!`;
    feedbackEl.className = "feedback ok";

    updateLevelTabsUI();
    updateWordsearchLockUI();
  }
}

/* ========== Word list & practice (spellings) ========== */
function getWordList() {
  if (currentContentMode === "robin") {
    const fromSheet = robinWordsRemote.length ? robinWordsRemote : null;
    const source = fromSheet || CURRENT_WEEK_SPELLINGS;
    return source.slice();
  } else if (currentContentMode === "eyfs") {
    const key = eyfsSetSelect.value;
    const set = EYFS_SETS[key];
    return set ? set.words.slice() : [];
  } else {
    // Numbers mode uses a different loop, no words
    return [];
  }
}

function pickNextWord() {
  if (!wordQueue.length) rebuildWordQueue();
  if (!wordQueue.length) {
    currentWordEl.textContent = "No words.";
    currentTargetWord = "";
    toggleSpeakButton();
    return;
  }

  const next = wordQueue.shift();
  currentTargetWord = next;

  let toShow = next;
  if (currentMode === 2) {
    toShow = maskWordForLevel2(next);
  } else if (currentMode === 3) {
    toShow = buildClueForLevel3(next);
  }

  currentWordEl.textContent = toShow;
  answerInput.value = "";
  answerInput.focus();
  feedbackEl.textContent = "";
  awaitingNextWord = false;
  checkButtonLabel.textContent = "Check";
  toggleSpeakButton();
}

function handleAnswer() {
  if (!currentLearner) return;

  if (awaitingNextWord){ 
    pickNextWord(); 
    return; 
  }

  const target = currentTargetWord.trim().toLowerCase();
  const guess = answerInput.value.trim().toLowerCase();

  if (!target || !guess){
    feedbackEl.textContent = "Type the word first.";
    feedbackEl.className = "feedback bad";
    return;
  }

  sessionTotal++;

  if (guess === target){
    sessionCorrect++;
    sessionStreak++;
    bestSessionStreak = Math.max(bestSessionStreak, sessionStreak);
    sessionXP += 10;

    feedbackEl.textContent = "Nice, that‚Äôs correct! üéâ";
    feedbackEl.className = "feedback ok";

    // Track towards unlocking next levels / wordsearch
    registerCorrectAnswerForCurrentLevel(currentTargetWord);
  } else {
    feedbackEl.textContent = `Close ‚Äì the correct spelling is ‚Äú${target}‚Äù.`;
    feedbackEl.className = "feedback bad";
    sessionStreak = 0;
  }

  refreshStatsUI();
  awaitingNextWord = true;
  checkButtonLabel.textContent = "Next word";
}

/* ========== Numbers: backend + loop ========== */

// Load this week's numbers from the Numbers_Current sheet
async function loadNumbersFromSheet() {
  numbersQuestions = [];
  try {
    if (!window.config || !window.config.spellingsUrl) return;
    const url = window.config.spellingsUrl + '?mode=numbers&t=' + Date.now();
    const resp = await fetch(url, { cache: 'no-store' });
    const data = await resp.json();
    if (Array.isArray(data.numbersCurrent)) {
      numbersQuestions = data.numbersCurrent
        .map(item => ({
          question: String(item.question || "").trim(),
          answer: String(item.answer || "").trim()
        }))
        .filter(q => q.question && q.answer);
    }
  } catch (err) {
    console.error('Error loading numbers from Sheet', err);
  }
}

// Turn "12 x 3" / "36 / 3" into "12 √ó 3" / "36 √∑ 3" for display
function prettyPrintQuestion(raw) {
  if (!raw) return "";
  let s = String(raw);

  // Normalise spacing
  s = s.replace(/\s+/g, " ").trim();

  // Replace operator characters with nicer symbols
  s = s.replace(/[xX*]/g, "√ó");
  s = s.replace(/\//g, "√∑");

  return s;
}

function showCurrentNumberQuestion() {
  if (!numbersQuestions.length) {
    if (currentQuestionEl) currentQuestionEl.textContent = "No questions set.";
    if (numbersFeedback) {
      numbersFeedback.textContent = "Ask an adult to add some questions to the Numbers_Current sheet.";
      numbersFeedback.className = "feedback bad";
    }
    if (numbersCheckButtonLabel) numbersCheckButtonLabel.textContent = "Check";
    if (typeof numbersProgressText !== "undefined" && numbersProgressText) {
      numbersProgressText.textContent = "";
    }
    return;
  }

  // End of this round: show honest summary
  if (numbersIndex >= numbersQuestions.length) {
    const got = sessionCorrect;
    const total = sessionTotal;

    if (currentQuestionEl) currentQuestionEl.textContent = "All done!";

    if (numbersFeedback) {
      let msg;
      if (!total) {
        msg = "No questions answered this round.";
      } else if (got === total) {
        msg = `Brilliant ‚Äì you got all ${total} correct! üéâ`;
      } else if (got === 0) {
        msg = `You‚Äôve tried all ${total} questions. Let‚Äôs have another go and see if we can get some right.`;
      } else {
        msg = `Nice work ‚Äì you got ${got} out of ${total} correct.`;
      }
      numbersFeedback.textContent = msg;
      numbersFeedback.className = "feedback ok";
    }

    if (typeof numbersProgressText !== "undefined" && numbersProgressText) {
      numbersProgressText.textContent = "All questions finished for this round.";
    }

    // Confetti only if at least one correct
    if (typeof confetti === "function" && sessionCorrect > 0) {
      confetti({
        particleCount: 150,
        spread: 70,
        origin: { y: 0.7 }
      });
    }

    if (numbersCheckButtonLabel) numbersCheckButtonLabel.textContent = "Again";
    numbersAwaitingNext = true;   // "Again" mode
    return;
  }

  // Normal question display
  const q = numbersQuestions[numbersIndex];

  if (typeof numbersProgressText !== "undefined" && numbersProgressText) {
    numbersProgressText.textContent =
      `Question ${numbersIndex + 1} of ${numbersQuestions.length}`;
  }

  const display =
    (typeof prettyPrintQuestion === "function")
      ? prettyPrintQuestion(q.question)
      : q.question;

  if (currentQuestionEl) currentQuestionEl.textContent = display;
  if (numbersAnswerInput) {
    numbersAnswerInput.value = "";
    numbersAnswerInput.focus();
  }
  if (numbersFeedback) {
    numbersFeedback.textContent = "";
    numbersFeedback.className = "feedback";
  }
  if (numbersCheckButtonLabel) numbersCheckButtonLabel.textContent = "Check";

  // We‚Äôre ready to *check* the next answer
  numbersAwaitingNext = false;
}

function handleNumbersAnswer() {
  if (!currentLearner) return;
  if (!numbersQuestions.length) return;

  // If we are waiting for "Next question" OR "Again"
  if (numbersAwaitingNext) {
    // Finished the round, "Again" clicked
    if (numbersIndex >= numbersQuestions.length) {
      numbersIndex = 0;
      shuffleArray(numbersQuestions);
      numbersAwaitingNext = false;
      showCurrentNumberQuestion();
      return;
    }

    // Mid-round: move on to the next question
    numbersAwaitingNext = false;
    numbersIndex++;
    showCurrentNumberQuestion();
    return;
  }

  // Normal case: checking the current answer
  const q = numbersQuestions[numbersIndex];
  const guessRaw = numbersAnswerInput ? numbersAnswerInput.value.trim() : "";
  if (!guessRaw) {
    if (numbersFeedback) {
      numbersFeedback.textContent = "Type an answer first.";
      numbersFeedback.className = "feedback bad";
    }
    return;
  }

  // Shared stats
  sessionTotal++;

  const correct = q.answer.trim();
  if (guessRaw === correct) {
    sessionCorrect++;
    sessionStreak++;
    bestSessionStreak = Math.max(bestSessionStreak, sessionStreak);
    sessionXP += 10;

    if (numbersFeedback) {
      numbersFeedback.textContent = "Correct! üéâ";
      numbersFeedback.className = "feedback ok";
    }
  } else {
    sessionStreak = 0;
    if (numbersFeedback) {
      numbersFeedback.textContent = `Almost ‚Äì the answer is ${correct}.`;
      numbersFeedback.className = "feedback bad";
    }
  }

  refreshStatsUI();

  // If this was the last question, go straight to summary
  if (numbersIndex >= numbersQuestions.length - 1) {
    numbersIndex++;
    showCurrentNumberQuestion();
  } else {
    // Otherwise, wait for "Next question"
    numbersAwaitingNext = true;
    if (numbersCheckButtonLabel) {
      numbersCheckButtonLabel.textContent = "Next question";
    }
  }
}
  
async function startNumbersMode() {
  if (numbersFeedback) {
    numbersFeedback.textContent = "";
    numbersFeedback.className = "feedback";
  }
  if (currentQuestionEl) currentQuestionEl.textContent = "Loading‚Ä¶";
  if (numbersProgressText) numbersProgressText.textContent = "";

  await loadNumbersFromSheet();

  if (!numbersQuestions.length) {
    if (currentQuestionEl) currentQuestionEl.textContent = "No questions.";
    if (numbersFeedback) {
      numbersFeedback.textContent = "No numbers set. Ask an adult to fill Numbers_Current.";
      numbersFeedback.className = "feedback bad";
    }
    if (numbersProgressText) numbersProgressText.textContent = "";
    return;
  }

  shuffleArray(numbersQuestions);
  numbersIndex = 0;
  numbersAwaitingNext = false;
  showCurrentNumberQuestion();
}

/* ========== UI ========== */
function initEYFSSelect(){
  eyfsSetSelect.innerHTML = "";
  Object.entries(EYFS_SETS).forEach(([key,val])=>{
    const opt = document.createElement("option");
    opt.value = key;
    opt.textContent = val.label;
    eyfsSetSelect.appendChild(opt);
  });
}

/* Show the right content options for each phase */
phaseSelect.addEventListener("change", () => {
  const phase = phaseSelect.value;

  const robinRadio   = document.querySelector('input[name="contentMode"][value="robin"]');
  const eyfsRadio    = document.querySelector('input[name="contentMode"][value="eyfs"]');
  const numbersRadio = document.querySelector('input[name="contentMode"][value="numbers"]');

  if (phase === "eyfs") {
    // EYFS: only show EYFS option
    if (robinModeOption)  robinModeOption.style.display = "none";
    if (numbersModeOption) numbersModeOption.style.display = "none";
    if (eyfsModeOption)   eyfsModeOption.style.display = "block";

    if (eyfsRadio) eyfsRadio.checked = true;
    currentContentMode = "eyfs";

    if (eyfsSetRow) eyfsSetRow.style.display = "block";
    return;
  }

  if (phase === "y3") {
    // Year 3: show Robin + Numbers, hide EYFS
    if (robinModeOption)  robinModeOption.style.display = "block";
    if (numbersModeOption) numbersModeOption.style.display = "block";
    if (eyfsModeOption)   eyfsModeOption.style.display = "none";

    const current = getRadioValue("contentMode");
    if (current === "eyfs" || !current) {
      if (robinRadio) robinRadio.checked = true;
      currentContentMode = "robin";
    }

    if (eyfsSetRow) eyfsSetRow.style.display = "none";
    return;
  }

  // Default / unknown phase: show Robin + EYFS, hide Numbers
  if (robinModeOption)  robinModeOption.style.display = "block";
  if (eyfsModeOption)   eyfsModeOption.style.display = "block";
  if (numbersModeOption) numbersModeOption.style.display = "none";

  const current = getRadioValue("contentMode");
  if (current === "numbers") {
    if (robinRadio) robinRadio.checked = true;
    currentContentMode = "robin";
  }

  if (eyfsSetRow) {
    eyfsSetRow.style.display = currentContentMode === "eyfs" ? "block" : "none";
  }
});

document.querySelectorAll('input[name="contentMode"]').forEach(radio=>{
  radio.addEventListener("change",()=>{
    currentContentMode = getRadioValue("contentMode") || "robin";
    eyfsSetRow.style.display = currentContentMode === "eyfs" ? "block" : "none";
  });
});

modeTabs.forEach(tab=>{
  tab.addEventListener("click",()=>{
    if (tab.classList.contains("disabled")) return;
    const mode = Number(tab.dataset.level);
    currentMode = mode;

    modeTabs.forEach(t=> t.classList.toggle("active", t===tab));

    if (currentTargetWord){
      let disp = currentTargetWord;
      if (currentMode === 2) {
        disp = maskWordForLevel2(currentTargetWord);
      } else if (currentMode === 3) {
        disp = buildClueForLevel3(currentTargetWord);
      }
      currentWordEl.textContent = disp;
      feedbackEl.textContent = "";
      awaitingNextWord = false;
      checkButtonLabel.textContent = "Check";
      toggleSpeakButton();
    } else {
      if (practiceStep.style.display === "block" && currentContentMode !== "numbers") {
        pickNextWord();
      }
    }
  });
});

startPracticeBtn.addEventListener("click",()=>{
  const name = learnerNameInput.value.trim();
  const phase = phaseSelect.value;
  if (!name){ alert("Enter a name."); return; }
  if (!phase){ alert("Choose a year/phase."); return; }

  currentLearner = name;
  currentPhase = phase;
  currentContentMode = getRadioValue("contentMode") || "robin";

  // Reset session stats
  sessionTotal = 0;
  sessionCorrect = 0;
  sessionStreak = 0;
  bestSessionStreak = 0;
  sessionXP = 0;
  refreshStatsUI();

  // Reset level progression
  levelCompletion = { 1:false, 2:false, 3:false };
  levelWordSets = {
    1: new Set(),
    2: new Set(),
    3: new Set()
  };
  updateLevelTabsUI();
  updateWordsearchLockUI();

  identityStep.style.display = "none";
  practiceStep.style.display = "block";

  if (currentContentMode === "numbers") {
    if (spellingsCard) spellingsCard.style.display = "none";
    if (numbersCard) numbersCard.style.display = "block";
    if (wordsearchStep) wordsearchStep.style.display = "none";

    subtitle.style.display = "none";
    modeLabel.innerHTML = `<strong>Numbers practice</strong> ‚Äì practising with ${name}.`;

    if (numbersTitle) numbersTitle.textContent = `Numbers practice: ${name}`;
    if (numbersListLabel) numbersListLabel.textContent = "Using this week‚Äôs numbers.";

    startNumbersMode();
    return;
  }

  // Spellings (Robin / EYFS)
  if (spellingsCard) spellingsCard.style.display = "block";
  if (numbersCard) numbersCard.style.display = "none";
  if (wordsearchStep) wordsearchStep.style.display = "block";

  activeLearnerTitle.textContent = `Practising: ${name}`;
  subtitle.style.display = "none";
  modeLabel.innerHTML = `<strong>Spellings practice</strong> ‚Äì practising with ${name}.`;

  if (currentContentMode === "robin"){
    listLabel.textContent = "Using this week‚Äôs spellings list.";
  } else {
    const set = EYFS_SETS[eyfsSetSelect.value];
    listLabel.textContent = set ? set.label : "EYFS blending set.";
  }

  rebuildWordQueue();
  pickNextWord();
});

eyfsSetSelect.addEventListener("change",()=>{
  if (practiceStep.style.display === "block" && currentContentMode==="eyfs"){
    const set = EYFS_SETS[eyfsSetSelect.value];
    listLabel.textContent = set ? set.label : "EYFS set.";
    rebuildWordQueue();
    pickNextWord();
  }
});

checkButton.addEventListener("click", handleAnswer);
answerInput.addEventListener("keydown", e=>{
  if (e.key==="Enter"){
    e.preventDefault();
    handleAnswer();
  }
});

function goBackToIdentity() {
  practiceStep.style.display = "none";
  wordsearchStep.style.display = "none";
  identityStep.style.display = "flex";

  if (spellingsCard) spellingsCard.style.display = "block";
  if (numbersCard) numbersCard.style.display = "none";

  modeLabel.innerHTML = "<strong>Spellings practice</strong>";
  subtitle.style.display = "block";
  subtitle.textContent = "Who‚Äôs practising? Enter your name and year to begin.";
}

if (changeLearnerLink) {
  changeLearnerLink.addEventListener("click", goBackToIdentity);
}
if (numbersChangeLearnerLink) {
  numbersChangeLearnerLink.addEventListener("click", goBackToIdentity);
}

if (speakButton) {
  speakButton.addEventListener("click", speakCurrentWord);
}

if (extraClueButton) {
  extraClueButton.addEventListener("click", () => {
    if (!currentTargetWord) return;
    currentWordEl.textContent = buildPatternForLevel3(currentTargetWord);
  });
}

/* Numbers button wiring */
if (numbersCheckButton) {
  numbersCheckButton.addEventListener("click", handleNumbersAnswer);
}
if (numbersAnswerInput) {
  numbersAnswerInput.addEventListener("keydown", e => {
    if (e.key === "Enter") {
      e.preventDefault();
      handleNumbersAnswer();
    }
  });
}

/* ===== Wordsearch logic ===== */
function clearDragSelection() {
  if (!wordsearchGridEl) return;
  const selectedCells = wordsearchGridEl.querySelectorAll('.ws-cell.ws-selected');
  selectedCells.forEach(cell => cell.classList.remove('ws-selected'));
  selectionCells = [];
}

function fireWordsearchCelebration() {
  if (typeof confetti === "function") {
    confetti({
      particleCount: 200,
      spread: 80,
      origin: { y: 0.6 }
    });
  }
}

function markWordFound(wordIndex, cells) {
  if (wordsearchFound.has(wordIndex)) return;
  wordsearchFound.add(wordIndex);

  const colour = wordsearchColours[wordIndex % wordsearchColours.length];
  cells.forEach(cell => {
    cell.classList.remove('ws-selected');
    cell.style.backgroundColor = colour;
    cell.style.color = '#111';
  });

  const span = wordsearchWordsEl.querySelector(`.ws-word[data-index="${wordIndex}"]`);
  if (span) span.classList.add('found');

  if (wordsearchFound.size === wordsearchCurrentWords.length && wordsearchCurrentWords.length > 0) {
    fireWordsearchCelebration();
  }
}

function generateWordsearch() {
  const wordsRaw = getWordList()
    .map(w => String(w || "").trim().toLowerCase())
    .filter(w => w.length > 0);

  if (!wordsRaw.length) {
    wordsearchGridEl.innerHTML = "<p>No words available for word search.</p>";
    wordsearchWordsEl.textContent = "";
    wordsearchCurrentWords = [];
    return;
  }

  const maxWords = 6;
  const selected = wordsRaw.slice(0, maxWords);

  const size = 10;
  const directions = [
    [0, 1],  // right
    [1, 0]   // down
  ];

  function tryBuildGrid() {
    const grid = Array.from({ length: size }, () => Array(size).fill(null));

    for (const word of selected) {
      if (word.length > size) {
        return null;
      }

      let placed = false;
      for (let attempts = 0; attempts < 100 && !placed; attempts++) {
        const [dr, dc] = directions[Math.floor(Math.random() * directions.length)];

        const maxRow = dr === 0 ? size - 1 : size - word.length;
        const maxCol = dc === 0 ? size - word.length : size - 1;
        const row = Math.floor(Math.random() * (maxRow + 1));
        const col = Math.floor(Math.random() * (maxCol + 1));

        let ok = true;
        for (let i = 0; i < word.length; i++) {
          const r = row + dr * i;
          const c = col + dc * i;
          const cell = grid[r][c];
          if (cell !== null && cell !== word[i]) {
            ok = false;
            break;
          }
        }
        if (!ok) continue;

        for (let i = 0; i < word.length; i++) {
          const r = row + dr * i;
          const c = col + dc * i;
          grid[r][c] = word[i];
        }
        placed = true;
      }

      if (!placed) {
        return null;
      }
    }

    return grid;
  }

  let grid = null;
  for (let attempt = 0; attempt < 40 && !grid; attempt++) {
    grid = tryBuildGrid();
  }
  if (!grid) {
    wordsearchGridEl.innerHTML = "<p>Could not place all words. Try again.</p>";
    wordsearchWordsEl.textContent = "";
    wordsearchCurrentWords = [];
    return;
  }

  for (let r = 0; r < size; r++) {
    for (let c = 0; c < size; c++) {
      if (!grid[r][c]) {
        const letter = String.fromCharCode(97 + Math.floor(Math.random() * 26));
        grid[r][c] = letter;
      }
    }
  }

  wordsearchCurrentWords = selected.slice();
  wordsearchFound = new Set();

  const table = document.createElement('table');
  table.className = 'ws-table';
  for (let r = 0; r < size; r++) {
    const tr = document.createElement('tr');
    for (let c = 0; c < size; c++) {
      const td = document.createElement('td');
      td.textContent = grid[r][c].toUpperCase();
      td.classList.add('ws-cell');
      td.dataset.r = String(r);
      td.dataset.c = String(c);
      tr.appendChild(td);
    }
    table.appendChild(tr);
  }
  wordsearchGridEl.innerHTML = '';
  wordsearchGridEl.appendChild(table);

  wordsearchWordsEl.innerHTML = '';
  wordsearchCurrentWords.forEach((w, idx) => {
    const span = document.createElement('span');
    span.className = 'ws-word';
    span.dataset.index = String(idx);
    span.textContent = w.toUpperCase();
    wordsearchWordsEl.appendChild(span);
  });
}

if (generateWordsearchBtn) {
  generateWordsearchBtn.addEventListener("click", generateWordsearch);
}

/* Wordsearch drag logic (mouse + touch) */
function getCellFromEvent(e) {
  if (e.touches && e.touches.length) {
    const t = e.touches[0];
    const el = document.elementFromPoint(t.clientX, t.clientY);
    if (!el) return null;
    return el.closest('.ws-cell');
  } else if (e.changedTouches && e.changedTouches.length) {
    const t = e.changedTouches[0];
    const el = document.elementFromPoint(t.clientX, t.clientY);
    if (!el) return null;
    return el.closest('.ws-cell');
  } else {
    return e.target.closest('.ws-cell');
  }
}

function updateSelectionToCell(cell) {
  clearDragSelection();
  if (!cell) return;

  const row = parseInt(cell.dataset.r, 10);
  const col = parseInt(cell.dataset.c, 10);

  if (dragStartRow === null || dragStartCol === null) {
    dragStartRow = row;
    dragStartCol = col;
  }

  const currR = row;
  const currC = col;

  if (dragStartRow === currR) {
    const minC = Math.min(dragStartCol, currC);
    const maxC = Math.max(dragStartCol, currC);
    for (let c = minC; c <= maxC; c++) {
      const el = wordsearchGridEl.querySelector(`.ws-cell[data-r="${dragStartRow}"][data-c="${c}"]`);
      if (el) {
        el.classList.add('ws-selected');
        selectionCells.push(el);
      }
    }
  } else if (dragStartCol === currC) {
    const minR = Math.min(dragStartRow, currR);
    const maxR = Math.max(dragStartRow, currR);
    for (let r = minR; r <= maxR; r++) {
      const el = wordsearchGridEl.querySelector(`.ws-cell[data-r="${r}"][data-c="${dragStartCol}"]`);
      if (el) {
        el.classList.add('ws-selected');
        selectionCells.push(el);
      }
    }
  }
}

function handleWordsearchDown(e) {
  const cell = getCellFromEvent(e);
  if (!cell) return;
  if (e.cancelable) e.preventDefault();

  selecting = true;
  dragStartRow = parseInt(cell.dataset.r, 10);
  dragStartCol = parseInt(cell.dataset.c, 10);
  updateSelectionToCell(cell);
}

function handleWordsearchMove(e) {
  if (!selecting) return;
  const cell = getCellFromEvent(e);
  if (!cell) return;
  if (e.cancelable) e.preventDefault();
  updateSelectionToCell(cell);
}

function handleWordsearchUp(e) {
  if (!selecting) return;
  selecting = false;

  if (!selectionCells.length) {
    clearDragSelection();
    dragStartRow = dragStartCol = null;
    return;
  }

  const letters = selectionCells.map(cell => cell.textContent.toLowerCase());
  const str = letters.join("");
  const rev = letters.slice().reverse().join("");

  let matchedIndex = -1;
  for (let i = 0; i < wordsearchCurrentWords.length; i++) {
    const w = wordsearchCurrentWords[i];
    if (w === str || w === rev) {
      matchedIndex = i;
      break;
    }
  }

  if (matchedIndex >= 0) {
    markWordFound(matchedIndex, selectionCells);
  } else {
    clearDragSelection();
  }

  dragStartRow = dragStartCol = null;
}

if (wordsearchGridEl) {
  wordsearchGridEl.addEventListener('mousedown', handleWordsearchDown);
  wordsearchGridEl.addEventListener('mousemove', handleWordsearchMove);
  document.addEventListener('mouseup', handleWordsearchUp);

  wordsearchGridEl.addEventListener('touchstart', handleWordsearchDown, { passive: false });
  wordsearchGridEl.addEventListener('touchmove', handleWordsearchMove, { passive: false });
  document.addEventListener('touchend', handleWordsearchUp);
  document.addEventListener('touchcancel', handleWordsearchUp);
}

/* ========== Boot ========== */
window.addEventListener('load',()=>{
  setInitialTheme();
  initEYFSSelect();
  loadRobinWordsFromSheet();
  updateLevelTabsUI();
  updateWordsearchLockUI();
});
</script>
</body>
</html>
